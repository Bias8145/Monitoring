<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Checklist Air</title>
    <!-- Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Poppins:wght@500;700&display=swap" rel="stylesheet">
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            font-weight: 400;
            line-height: 1.5;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background 0.3s ease;
        }

        /* Tema Terang */
        body.light-theme {
            background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
            color: #333;
        }

        body.light-theme .container,
        body.light-theme .login-card,
        body.light-theme .modal {
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
        }

        body.light-theme .card {
            background: rgba(245, 245, 245, 0.9);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }

        body.light-theme .header {
            background: linear-gradient(135deg, #ffffff, #e0e0e0);
            color: #333;
        }

        body.light-theme .form-group select,
        body.light-theme .form-group input,
        body.light-theme .form-group textarea,
        body.light-theme .login-card input {
            background: rgba(220, 220, 220, 0.85);
            color: #333;
        }

        body.light-theme .unit {
            background: rgba(76, 175, 80, 0.3);
            color: #333;
        }

        body.light-theme .switch-type {
            background: rgba(220, 220, 220, 0.9);
        }

        body.light-theme .switch-btn {
            color: #333;
        }

        body.light-theme table {
            background: rgba(245, 245, 245, 0.9);
        }

        body.light-theme th {
            background: rgba(230, 230, 230, 0.95);
            font-size: 12px;
        }

        body.light-theme td {
            font-size: 12px;
        }

        body.light-theme .theme-toggle,
        body.light-theme .data-management-toggle {
            background: rgba(220, 220, 220, 0.85);
            color: #333;
        }

        body.light-theme .nav-bar {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        body.light-theme .nav-item {
            color: #333;
        }

        body.light-theme .nav-item:hover {
            background: rgba(76, 175, 80, 0.1);
        }

        /* Tema Gelap */
        body.dark-theme {
            background: linear-gradient(135deg, #1e1e2f, #2a2a4a);
            color: #e0e0e0;
        }

        body.dark-theme .container,
        body.dark-theme .login-card,
        body.dark-theme .modal {
            background: rgba(30, 30, 46, 0.85);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5);
        }

        body.dark-theme .card {
            background: rgba(40, 40, 60, 0.9);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
        }

        body.dark-theme .header {
            background: linear-gradient(135deg, #2e2e4a, #3a3a5a);
            color: #e0e0e0;
        }

        body.dark-theme .form-group select,
        body.dark-theme .form-group input,
        body.dark-theme .form-group textarea,
        body.dark-theme .login-card input {
            background: rgba(50, 50, 70, 0.85);
            color: #e0e0e0;
            font-size: 13px;
        }

        body.dark-theme .unit {
            background: rgba(76, 175, 80, 0.2);
            color: #e0e0e0;
        }

        body.dark-theme .switch-type {
            background: rgba(40, 40, 60, 0.9);
        }

        body.dark-theme .switch-btn {
            color: #e0e0e0;
        }

        body.dark-theme table {
            background: rgba(40, 40, 60, 0.9);
        }

        body.dark-theme th {
            background: rgba(50, 50, 70, 0.95);
            font-size: 12px;
        }

        body.dark-theme td {
            font-size: 12px;
        }

        body.dark-theme .theme-toggle,
        body.dark-theme .data-management-toggle {
            background: rgba(50, 50, 70, 0.85);
            color: #e0e0e0;
        }

        body.dark-theme .nav-bar {
            background: rgba(30, 30, 46, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        body.dark-theme .nav-item {
            color: #e0e0e0;
        }

        body.dark-theme .nav-item:hover {
            background: rgba(76, 175, 80, 0.3);
        }

        .container {
            max-width: 600px;
            width: 100%;
            border-radius: 20px;
            backdrop-filter: blur(12px);
            overflow: hidden;
            position: relative;
            z-index: 1;
            padding-bottom: 100px;
        }

        .card {
            border-radius: 16px;
            padding: 20px;
            margin: 15px;
            transform: perspective(1000px) rotateX(3deg) translateZ(10px);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: perspective(1000px) rotateX(0deg) translateZ(20px);
        }

        .header {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px 20px 0 0;
            position: relative;
            transform: perspective(1000px) translateZ(15px);
        }

        .header h1 {
            font-family: 'Poppins', 'Roboto', sans-serif;
            font-weight: 700;
            font-size: 22px;
            margin-bottom: 8px;
        }

        .header .greeting {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .header .subtitle {
            font-size: 14px;
            opacity: 0.7;
        }

        .form-group {
            margin-bottom: 20px;
            position: relative;
            transform: perspective(1000px) translateZ(5px);
        }

        .form-group select,
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 12px;
            font-size: 13px;
            transition: background 0.3s ease, box-shadow 0.3s ease;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-group select:focus,
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.3);
        }

        .input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .unit {
            padding: 12px;
            border-radius: 12px;
            min-width: 50px;
            text-align: center;
            font-size: 13px;
        }

        .section-divider {
            height: 2px;
            background: linear-gradient(90deg, #4CAF50, #81C784);
            margin: 20px 0;
            border-radius: 2px;
            transform: perspective(1000px) translateZ(5px);
        }

        .switch-type {
            display: flex;
            gap: 10px;
            border-radius: 12px;
            padding: 8px;
            margin-bottom: 20px;
            transform: perspective(1000px) translateZ(10px);
        }

        .switch-btn {
            flex: 1;
            padding: 12px;
            text-align: center;
            border: none;
            border-radius: 10px;
            background: none;
            cursor: pointer;
            font-weight: 500;
            font-size: 13px;
            transition: all 0.3s ease;
        }

        .switch-btn.active {
            background: #4CAF50;
            color: white;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
        }

        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            transition: all 0.3s ease;
            transform: perspective(1000px) translateZ(10px);
            position: relative;
        }

        .btn:hover {
            transform: perspective(1000px) translateZ(20px);
            box-shadow: 0 8px 20px rgba(76, 175, 80, 0.4);
        }

        .btn.loading::after {
            content: '';
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #fff;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .table-container {
            max-height: 300px;
            overflow-y: auto;
            margin: 15px 0;
            border-radius: 12px;
            transform: perspective(1000px) translateZ(5px);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            border-radius: 12px;
            overflow: hidden;
        }

        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        th {
            position: sticky;
            top: 0;
            font-weight: 600;
        }

        td button {
            padding: 8px 12px;
            border: none;
            border-radius: 10px;
            background: #4CAF50;
            color: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            transform: perspective(1000px) translateZ(5px);
        }

        td button:hover {
            background: #45a049;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
            transform: perspective(1000px) translateZ(10px);
        }

        td button.whatsapp-btn {
            background: #25D366;
        }

        td button.whatsapp-btn:hover {
            background: #20B058;
            box-shadow: 0 4px 12px rgba(37, 211, 102, 0.4);
        }

        td button.edit-btn {
            background: #FFC107;
            color: #333;
        }

        td button.edit-btn:hover {
            background: #FFB300;
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.4);
        }

        td button.edit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .filter-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            transform: perspective(1000px) translateZ(5px);
        }

        .filter-group select {
            flex: 1;
            min-width: 120px;
            padding: 12px;
            border-radius: 12px;
            font-size: 13px;
        }

        .login-container {
            max-width: 400px;
            width: 100%;
            text-align: center;
            position: relative;
            z-index: 1;
        }

        .login-card {
            backdrop-filter: blur(12px);
            padding: 30px;
            border-radius: 20px;
            transform: perspective(1000px) rotateX(5deg) translateZ(20px);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .login-card:hover {
            transform: perspective(1000px) rotateX(0deg) translateZ(30px);
        }

        .login-card h1 {
            font-family: 'Poppins', 'Roboto', sans-serif;
            font-size: 26px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .login-card .subtitle {
            font-size: 16px;
            opacity: 0.7;
            margin-bottom: 20px;
        }

        .login-card input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: none;
            border-radius: 12px;
            font-size: 13px;
            transform: perspective(1000px) translateZ(5px);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(244, 67, 54, 0.9);
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: none;
            font-size: 14px;
            transform: perspective(1000px) translateZ(10px);
            z-index: 1000;
        }

        .notification.success {
            background: rgba(76, 175, 80, 0.9);
        }

        .theme-toggle,
        .data-management-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 1000;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
        }

        .data-management-toggle {
            top: 74px;
        }

        .theme-toggle i,
        .data-management-toggle i {
            font-size: 24px;
        }

        .nav-bar {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            max-width: 600px;
            width: 90%;
            display: flex;
            justify-content: space-around;
            padding: 12px 16px;
            border-radius: 16px;
            z-index: 1000;
            transition: all 0.3s ease;
            backdrop-filter: blur(12px);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            padding: 8px 12px;
            font-size: 10px;
            transition: all 0.3s ease;
            border-radius: 12px;
            position: relative;
        }

        .nav-item i {
            font-size: 18px;
            margin-bottom: 4px;
        }

        .nav-item span {
            font-size: 9px;
            font-weight: 500;
        }

        .nav-item.active {
            background: #4CAF50;
            color: white;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.4);
        }

        .nav-item:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 10px;
            white-space: nowrap;
            z-index: 10;
        }

        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            padding: 20px;
            border-radius: 12px;
            z-index: 1000;
            backdrop-filter: blur(12px);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .modal-header h2 {
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: inherit;
        }

        .modal-content {
            font-size: 13px;
            line-height: 1.5;
        }

        .modal-content ul {
            list-style-type: disc;
            margin-left: 20px;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        .accordion {
            margin-bottom: 10px;
            border-radius: 8px;
            overflow: hidden;
        }

        .accordion-header {
            padding: 15px;
            cursor: pointer;
            font-weight: 600;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .accordion-content {
            padding: 15px;
            display: none;
            background: rgba(255, 255, 255, 0.1);
        }

        .accordion-content.active {
            display: block;
        }

        .accordion-content a {
            color: #4CAF50;
            text-decoration: underline;
        }

        .estimation-result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
        }

        .chart-container {
            margin-top: 20px;
            max-width: 100%;
            height: 300px;
        }

        .delete-data-btn {
            background: #F44336;
            margin-top: 10px;
        }

        .delete-data-btn:hover {
            background: #D32F2F;
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.4);
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        .pagination button {
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            background: #4CAF50;
            color: white;
            cursor: pointer;
            font-size: 12px;
        }

        .pagination button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        @media (max-width: 600px) {
            .container, .login-container {
                max-width: 100%;
                padding: 10px;
                padding-bottom: 80px;
            }

            .nav-bar {
                padding: 8px;
                bottom: 10px;
            }

            .nav-item {
                font-size: 8px;
                padding: 6px 8px;
            }

            .nav-item i {
                font-size: 16px;
            }
        }
    </style>
</head>

<body class="dark-theme">
    <!-- Tombol Tema -->
    <div class="theme-toggle" id="themeToggle">
        <i id="themeIcon" class="fas fa-sun"></i>
    </div>
    <!-- Tombol Manajemen Data (hanya untuk CA00383) -->
    <div class="data-management-toggle" id="dataManagementToggle" style="display: none;">
        <i class="fas fa-trash-alt"></i>
    </div>

    <!-- Navigation Bar -->
    <nav class="nav-bar">
        <div class="nav-item active" data-page="mainPage" data-tooltip="Checklist">
            <i class="fas fa-list-check"></i>
            <span>Checklist</span>
        </div>
        <div class="nav-item" data-page="meterPage" data-tooltip="Meter Lapangan">
            <i class="fas fa-tachometer-alt"></i>
            <span>Meter Lapangan</span>
        </div>
        <div class="nav-item" data-page="damagePage" data-tooltip="Kerusakan">
            <i class="fas fa-exclamation-triangle"></i>
            <span>Kerusakan</span>
        </div>
        <div class="nav-item" data-page="estimationPage" data-tooltip="Estimasi">
            <i class="fas fa-chart-line"></i>
            <span>Estimasi</span>
        </div>
        <div class="nav-item" data-page="educationPage" data-tooltip="Edukasi">
            <i class="fas fa-book"></i>
            <span>Edukasi</span>
        </div>
    </nav>

    <!-- Halaman Login -->
    <div id="loginPage" class="login-container">
        <div class="login-card">
            <h1>Water Monitoring & Maintaining System WTP Departement</h1>
            <div class="subtitle">Login Aman</div>
            <div class="form-group">
                <input type="text" id="nikInput" placeholder="Masukkan NIK (Contoh: CA00006)" required>
            </div>
            <button class="btn" id="loginButton">Masuk</button>
        </div>
    </div>

    <!-- Halaman Checklist -->
    <div id="mainPage" class="container" style="display: none;">
        <div class="header">
            <div class="greeting" id="greeting">Selamat Pagi, User!</div>
            <h1>Checklist Sistem Air</h1>
            <div class="subtitle">Monitoring & Pemeliharaan</div>
        </div>

        <div class="card">
            <div class="shift-info">Shift: <span id="shiftInfo"></span> | Waktu: <span id="currentTime">00:00:00</span></div>
        </div>

        <div class="card">
            <div class="switch-type">
                <button class="switch-btn active" id="switchMasuk">CHECKLIST MASUK</button>
                <button class="switch-btn" id="switchPulang">CHECKLIST PULANG</button>
                <button class="switch-btn" id="switchCustom">CUSTOM CHECKLIST</button>
            </div>
        </div>

        <div class="card" id="checklistFormContainer">
            <form id="checklistForm">
                <div class="form-group">
                    <select id="bakRO" required>
                        <option value="">Pilih Kondisi Bak Distribusi Air RO...</option>
                        <option value="Memadai">Memadai</option>
                        <option value="Tidak Memadai">Tidak Memadai</option>
                    </select>
                </div>
                <div class="form-group">
                    <div class="input-group">
                        <input type="number" id="tinggiRO" placeholder="Ketinggian Bak RO (cm)" required>
                        <div class="unit">cm</div>
                    </div>
                </div>
                <div class="section-divider"></div>
                <div class="form-group">
                    <select id="bakWWTP" required>
                        <option value="">Pilih Kondisi Bak Distribusi WWTP...</option>
                        <option value="Memadai">Memadai</option>
                        <option value="Tidak Memadai">Tidak Memadai</option>
                    </select>
                </div>
                <div class="form-group">
                    <div class="input-group">
                        <input type="number" id="tinggiWWTP" placeholder="Ketinggian Bak Distribusi WWTP (cm)" required>
                        <div class="unit">cm</div>
                    </div>
                </div>
                <div class="section-divider"></div>
                <div class="form-group">
                    <select id="pompa" required>
                        <option value="">Pilih Kondisi Pompa Transfer WWTP RO...</option>
                        <option value="ON">ON</option>
                        <option value="OFF">OFF</option>
                    </select>
                </div>
                <div class="section-divider"></div>
                <div class="form-group">
                    <div class="input-group">
                        <input type="number" id="tinggiPDAM" placeholder="Ketinggian Bak Input Air PDAM (cm)" required>
                        <div class="unit">cm</div>
                    </div>
                </div>
                <div class="form-group">
                    <select id="statusPDAM" required>
                        <option value="">Pilih Status Bak Input PDAM...</option>
                        <option value="Memadai">Memadai</option>
                        <option value="Tidak Memadai">Tidak Memadai</option>
                    </select>
                </div>
                <div class="form-group">
                    <select id="hydrantStatus" required>
                        <option value="">Pilih Status Hydrant...</option>
                        <option value="ON">ON</option>
                        <option value="OFF">OFF</option>
                    </select>
                </div>
                <div class="section-divider"></div>
                <div class="form-group">
                    <select id="supplyPDAM" required>
                        <option value="">Pilih Status Supply Air PDAM...</option>
                        <option value="Menyala">Menyala</option>
                        <option value="Mati">Mati</option>
                    </select>
                </div>
                <div class="form-group">
                    <input type="number" id="meterIndukPDAM" placeholder="Angka Meter Induk PDAM" required>
                </div>
                <div class="form-group">
                    <input type="number" id="meterIndukWTP" placeholder="Angka Meter Induk WTP" required>
                </div>
                <div class="form-group">
                    <div class="input-group">
                        <input type="number" id="PDAM" placeholder="Flow Input PDAM (m³)" required>
                        <div class="unit">m³</div>
                    </div>
                </div>
                <div class="form-group">
                    <div class="input-group">
                        <input type="number" id="flowPDAM" placeholder="Rate Input (m³/j) isi 0 jika pdam off" required>
                        <div class="unit">m³/j</div>
                    </div>
                </div>
                <div class="form-group">
                    <input type="text" id="catatan" placeholder="Catatan Tambahan (Opsional)">
                </div>
                <button type="submit" class="btn" id="saveChecklistButton">Simpan Checklist</button>
            </form>
        </div>

        <div class="card" id="reportSection">
            <h2 style="margin-bottom: 12px; font-size: 18px; font-weight: 600;">Laporan Checklist</h2>
            <div class="filter-group">
                <select id="filterDate">
                    <option value="">Semua Tanggal</option>
                </select>
                <select id="filterShift">
                    <option value="">Semua Shift</option>
                    <option value="masuk">Masuk</option>
                    <option value="pulang">Pulang</option>
                    <option value="custom">Custom</option>
                </select>
                <select id="filterNIK">
                    <option value="">Semua Pengguna</option>
                </select>
            </div>
            <div class="table-container">
                <table id="reportTable">
                    <thead>
                        <tr>
                            <th>Tanggal</th>
                            <th>Waktu</th>
                            <th>Shift</th>
                            <th>Penginput</th>
                            <th>Catatan</th>
                            <th>Detail</th>
                            <th>Share</th>
                            <th>Edit</th>
                        </tr>
                    </thead>
                    <tbody id="reportBody"></tbody>
                </table>
            </div>
            <div class="pagination" id="reportPagination"></div>
        </div>
    </div>

    <!-- Halaman Check Meter Lapangan -->
    <div id="meterPage" class="container" style="display: none;">
        <div class="header">
            <div class="greeting" id="meterGreeting">Selamat Pagi, User!</div>
            <h1>Check Meter Lapangan</h1>
            <div class="subtitle">Monitoring Meter Air</div>
        </div>
        <div class="card">
            <form id="meterForm">
                <div class="form-group">
                    <select id="meterBlock" required>
                        <option value="">Pilih Blok...</option>
                        <option value="Induk">Induk</option>
                        <option value="Blok A">Blok A</option>
                        <option value="Blok B">Blok B</option>
                        <option value="Blok C">Blok C</option>
                        <option value="Blok D">Blok D</option>
                        <option value="Blok E">Blok E</option>
                        <option value="Blok F">Blok F</option>
                        <option value="Blok G">Blok G</option>
                        <option value="Blok H">Blok H</option>
                        <option value="Blok P">Blok P</option>
                        <option value="Blok J">Blok J</option>
                    </select>
                </div>
                <div class="form-group">
                    <select id="meterLocation" required>
                        <option value="">Pilih Lokasi...</option>
                    </select>
                </div>
                <div class="form-group">
                    <div class="input-group">
                        <input type="number" id="meterReading" placeholder="Angka Meter" required>
                        <div class="unit">m³</div>
                    </div>
                </div>
                <div class="form-group">
                    <div id="actualUsage" style="font-size: 13px; margin-top: 10px;"></div>
                </div>
                <div class="form-group">
                    <input type="text" id="meterNotes" placeholder="Catatan (Opsional)">
                </div>
                <button type="submit" class="btn" id="saveMeterButton">Simpan Meter</button>
            </form>
        </div>
        <div class="card">
            <h2 style="margin-bottom: 12px; font-size: 18px; font-weight: 600;">Laporan Meter</h2>
            <div class="filter-group">
                <select id="meterFilterBlock">
                    <option value="">Semua Blok</option>
                </select>
                <select id="meterFilterDate">
                    <option value="">Semua Tanggal</option>
                </select>
            </div>
            <div class="table-container">
                <table id="meterTable">
                    <thead>
                        <tr>
                            <th>Tanggal</th>
                            <th>Waktu</th>
                            <th>Blok</th>
                            <th>Lokasi</th>
                            <th>Angka Meter</th>
                            <th>Aktual</th>
                            <th>Catatan</th>
                            <th>Share</th>
                        </tr>
                    </thead>
                    <tbody id="meterReportBody"></tbody>
                </table>
            </div>
            <div class="pagination" id="meterPagination"></div>
        </div>
    </div>

    <!-- Halaman Laporan Kerusakan -->
    <div id="damagePage" class="container" style="display: none;">
        <div class="header">
            <div class="greeting" id="damageGreeting">Selamat Pagi, User!</div>
            <h1>Laporan Kerusakan</h1>
            <div class="subtitle">Pelaporan Kerusakan</div>
        </div>
        <div class="card">
            <form id="damageForm">
                <div class="form-group">
                    <select id="damageType" required>
                        <option value="">Pilih Jenis Kerusakan...</option>
                        <option value="Kebocoran">Kebocoran</option>
                        <option value="Kerusakan Pipa">Kerusakan Pipa</option>
                        <option value="Pompa Mati">Pompa Mati</option>
                        <option value="Lainnya">Lainnya</option>
                    </select>
                </div>
                <div class="form-group">
                    <select id="damageBlock" required>
                        <option value="">Pilih Blok...</option>
                        <option value="Induk">Induk</option>
                        <option value="Blok A">Blok A</option>
                        <option value="Blok B">Blok B</option>
                        <option value="Blok C">Blok C</option>
                        <option value="Blok D">Blok D</option>
                        <option value="Blok E">Blok E</option>
                        <option value="Blok F">Blok F</option>
                        <option value="Blok G">Blok G</option>
                        <option value="Blok H">Blok H</option>
                        <option value="Blok P">Blok P</option>
                        <option value="Blok J">Blok J</option>
                    </select>
                </div>
                <div class="form-group">
                    <select id="damageLocation" required>
                        <option value="">Pilih Lokasi...</option>
                    </select>
                </div>
                <div class="form-group">
                    <input type="text" id="damageSpecific" placeholder="Spesifik Lokasi" required>
                </div>
                <div class="form-group">
                    <textarea id="damageNotes" placeholder="Catatan"></textarea>
                </div>
                <button type="submit" class="btn" id="saveDamageButton">Simpan Laporan</button>
            </form>
        </div>
        <div class="card">
            <h2 style="margin-bottom: 12px; font-size: 18px; font-weight: 600;">Laporan Kerusakan</h2>
            <div class="filter-group">
                <select id="damageFilterBlock">
                    <option value="">Semua Blok</option>
                </select>
                <select id="damageFilterDate">
                    <option value="">Semua Tanggal</option>
                </select>
            </div>
            <div class="table-container">
                <table id="damageTable">
                    <thead>
                        <tr>
                            <th>Tanggal</th>
                            <th>Jenis Kerusakan</th>
                            <th>Blok</th>
                            <th>Lokasi</th>
                            <th>Spesifik</th>
                            <th>Catatan</th>
                            <th>Share</th>
                        </tr>
                    </thead>
                    <tbody id="damageReportBody"></tbody>
                </table>
            </div>
            <div class="pagination" id="damagePagination"></div>
        </div>
    </div>

    <!-- Halaman Estimasi Pemakaian Air -->
    <div id="estimationPage" class="container" style="display: none;">
        <div class="header">
            <div class="greeting" id="estimationGreeting">Selamat Pagi, User!</div>
            <h1>Estimasi Pemakaian Air</h1>
            <div class="subtitle">Perhitungan dan Visualisasi</div>
        </div>
        <div class="card">
            <div class="switch-type">
                <button class="switch-btn active" id="switchAutoEstimation">Otomatis</button>
                <button class="switch-btn" id="switchManualEstimation">Manual</button>
            </div>
            <form id="estimationForm">
                <div id="autoEstimationFields">
                    <div class="filter-group">
                        <select id="estimationBlock" required>
                            <option value="">Pilih Blok...</option>
                            <option value="Induk">Induk</option>
                            <option value="Blok A">Blok A</option>
                            <option value="Blok B">Blok B</option>
                            <option value="Blok C">Blok C</option>
                            <option value="Blok D">Blok D</option>
                            <option value="Blok E">Blok E</option>
                            <option value="Blok F">Blok F</option>
                            <option value="Blok G">Blok G</option>
                            <option value="Blok H">Blok H</option>
                            <option value="Blok P">Blok P</option>
                            <option value="Blok J">Blok J</option>
                        </select>
                        <input type="date" id="estimationDate" required>
                        <select id="estimationTimeRange" required>
                            <option value="">Pilih Rentang Waktu...</option>
                            <option value="1">1 Jam</option>
                            <option value="2">2 Jam</option>
                            <option value="3">3 Jam</option>
                            <option value="4">4 Jam</option>
                            <option value="6">6 Jam</option>
                            <option value="12">12 Jam</option>
                            <option value="24">24 Jam</option>
                        </select>
                    </div>
                </div>
                <div id="manualEstimationFields" style="display: none;">
                    <div class="form-group">
                        <div class="input-group">
                            <input type="number" id="manualTinggiRO" placeholder="Ketinggian Bak RO (cm)" min="0">
                            <div class="unit">cm</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="input-group">
                            <input type="number" id="manualTinggiWWTP" placeholder="Ketinggian Bak Distribusi WWTP (cm)" min="0">
                            <div class="unit">cm</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="input-group">
                            <input type="number" id="manualTinggiPDAM" placeholder="Ketinggian Bak Input PDAM (cm)" min="0">
                            <div class="unit">cm</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="input-group">
                            <input type="number" id="manualFlowPDAM" placeholder="Flow PDAM (m³)" min="0">
                            <div class="unit">m³</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="input-group">
                            <input type="number" id="meterReading1" placeholder="Pembacaan Meter 1 (m³)" min="0">
                            <div class="unit">m³</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="input-group">
                            <input type="number" id="meterReading2" placeholder="Pembacaan Meter 2 (m³)" min="0">
                            <div class="unit">m³</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="input-group">
                            <input type="number" id="meterReading3" placeholder="Pembacaan Meter 3 (m³)" min="0">
                            <div class="unit">m³</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="input-group">
                            <input type="number" id="meterReading4" placeholder="Pembacaan Meter 4 (m³)" min="0">
                            <div class="unit">m³</div>
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn" id="calculateEstimationButton">Hitung Estimasi</button>
            </form>
            <div class="estimation-result" id="estimationResult" style="display: none;">
                <h3>Hasil Estimasi</h3>
                <p><strong>Rata-rata Pemakaian per Jam:</strong> <span id="avgUsage"></span> m³</p>
                <p><strong>Estimasi Pemakaian Total:</strong> <span id="totalUsage"></span> m³</p>
                <p><strong>Status Bak:</strong> <span id="tankStatus"></span></p>
                <p><strong>Kecukupan Suplai Air:</strong> <span id="supplyStatus"></span></p>
                <p><strong>Proyeksi Kebutuhan Air (24 Jam):</strong> <span id="projectedUsage"></span> m³</p>
            </div>
            <div class="chart-container">
                <canvas id="usageChart"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Halaman Katalog Edukasi -->
    <div id="educationPage" class="container" style="display: none;">
        <div class="header">
            <div class="greeting" id="educationGreeting">Selamat Pagi, User!</div>
            <h1>Katalog Edukasi</h1>
            <div class="subtitle">Informasi dan Edukasi Air</div>
        </div>
        <div class="card">
            <div class="form-group">
                <input type="text" id="educationSearch" placeholder="Cari Konten Edukasi...">
            </div>
            <div class="form-group">
                <select id="educationCategory" required>
                    <option value="">Pilih Kategori...</option>
                    <option value="K3">K3</option>
                    <option value="Spesifikasi Pipa">Spesifikasi Pipa</option>
                    <option value="Baku Mutu Air">Baku Mutu Air</option>
                    <option value="Ranah Penggunaan Air">Ranah Penggunaan Air</option>
                    <option value="Konsumsi Harian Air">Konsumsi Harian Air</option>
                    <option value="Water Treatment Plant">Water Treatment Plant</option>
                </select>
            </div>
            <div id="educationContent"></div>
        </div>
    </div>

    <!-- Halaman Manajemen Data (hanya untuk CA00383) -->
    <div id="dataManagementPage" class="container" style="display: none;">
        <div class="header">
            <div class="greeting" id="dataManagementGreeting">Selamat Pagi, User!</div>
            <h1>Manajemen Data</h1>
            <div class="subtitle">Hapus Data Lama</div>
        </div>
        <div class="card">
            <div class="form-group">
                <select id="dataType" required>
                    <option value="">Pilih Tipe Data...</option>
                    <option value="checklists">Checklist</option>
                    <option value="meters">Meter</option>
                    <option value="damages">Kerusakan</option>
                </select>
            </div>
            <div class="form-group">
                <input type="date" id="dataDeleteDate" required>
            </div>
            <button class="btn delete-data-btn" id="deleteDataButton">Hapus Data</button>
        </div>
    </div>

    <!-- Modal untuk Detail Laporan -->
    <div id="modalOverlay" class="modal-overlay"></div>
    <div id="detailModal" class="modal">
        <div class="modal-header">
            <h2>Detail Checklist</h2>
            <button class="modal-close" id="modalClose">&times;</button>
        </div>
        <div class="modal-content" id="modalContent"></div>
    </div>

    <div id="notification" class="notification"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, onSnapshot, query, orderBy, serverTimestamp, where, updateDoc, doc, deleteDoc, startAfter, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBPmuyBT8tTr5V0yZJNbjHHLz_-iY2djpo",
            authDomain: "water-checklist.firebaseapp.com",
            projectId: "water-checklist",
            storageBucket: "water-checklist.firebasestorage.app",
            messagingSenderId: "84158811467",
            appId: "1:84158811467:web:717bd038c3da5362ad2cce"
        };

        let db;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            console.log('Firebase berhasil diinisialisasi');
        } catch (error) {
            console.error('Gagal menginisialisasi Firebase:', error);
            showNotification('Gagal menginisialisasi aplikasi. Silakan coba lagi nanti.');
        }

        const users = [
            { nik: 'CA00006', name: 'Muhammad Fahruroji' },
            { nik: 'CA00159', name: 'Andri Rahmatulloh' },
            { nik: 'CA00193', name: 'IIP M Ilyas' },
            { nik: 'CA00198', name: 'Shashi Prasetyo' },
            { nik: 'CA00210', name: 'Ridwan Fauzi' },
            { nik: 'CA00383', name: 'Bias Fajar Khaliq' },
            { nik: 'CA00491', name: 'Torik Hidayat' },
            { nik: 'CA00508', name: 'Amanda Lutfi' }
        ];

        let currentType = 'masuk';
        let currentNIK = '';
        let currentUserName = '';
        let estimationMode = 'auto';
        let usageChart = null;
        const ITEMS_PER_PAGE = 10;

        const shifts = [
            { name: 'Satu', start: 7, end: 15, startInput: '07:00', endInput: '07:30', startOutput: '14:30', endOutput: '15:00' },
            { name: 'Dua', start: 15, end: 23, startInput: '15:00', endInput: '15:30', startOutput: '22:30', endOutput: '23:00' },
            { name: 'Tiga', start: 23, end: 7, startInput: '23:00', endInput: '23:30', startOutput: '06:30', endOutput: '07:00' }
        ];

        const blockLocations = {
            'Induk': ['Aquaria', 'Hydran', 'Induk Blok A B C', 'Induk P+D', 'Damkar', 'Blok H', 'Blok E, F, G', 'PDAM', 'PDAM II', 'Hydrant II'],
            'Blok C': ['Toilet C11', 'Toilet C8', 'Toilet C15', 'Toilet C12', 'Toilet C17', 'Toilet C20', 'Manual 1', 'Manual 2', 'Manual 3', 'Manual 4', 'Manual 5'],
            'Blok B': ['B1 Stockfit', 'B1.2 Mesin', 'B1.3 Mesin', 'B1.4 Mesin', 'B3 Cooling Tower', 'B3.2 Mesin', 'B3.3 Mesin', 'B6.1 Toilet', 'B6.2 Toilet', 'B7.1 Toilet', 'B7.2 Toilet'],
            'Blok D': ['D1 Kantin TKA/Dapur', 'D2.1 Mess Bungalow', 'D2.2 Mess Bungalow', 'D2.3 Mess Bungalow', 'D2.6 Mess Bungalow', 'D2.7 Mess Bungalow', 'D2.8 Mess Bungalow', 'D13 Mess Bungalow', 'D3.1 Mess Bungalow', 'D3.2 Mess Bungalow', 'D4.2 Mess Bungalow', 'D5 Mess Bungalow', 'D5 Bungalow'],
            'Blok P': ['P1.1 Toilet', 'P1.2 Toilet', 'Galon', 'Send', 'Carbon', 'Sumur Bor', 'P2 Aquaria', 'P4 WWTP', 'P7 Toilet', 'P8 Office Pusat', 'P10 Kantin', 'P11.1 Toilet', 'P11.2 Kantin Dapur', 'P16 Masjid', 'P21 Damkar', 'P9', 'P17 Masjid'],
            'Blok J': ['J1 Mess Bungalow', 'J2 Mess Bungalow'],
            'Blok A': ['A10 Toilet', 'A17 Toilet', 'A14 Toilet', 'A22 Toilet', 'A19 Toilet', 'A2 Office II', 'A1 Office I', 'A5.2 Sablon', 'A5.1', 'A5 Lab', 'A23 Cooling Tower'],
            'Blok F': ['F1 Lab', 'F3.1 Toilet', 'F3.2 Toilet', 'F3.3 Toilet', 'F3.4 Toilet', 'G8.1 Toilet', 'G8.2 Toilet'],
            'Blok G': ['G12 Cooling Tower', 'G14.1 Mesin', 'G14.2 Cooling Tower', 'G15.1 Toilet', 'G15.2 Toilet'],
            'Blok H': ['H2 Masjid', 'H4 Kantin', 'H5.1 Toilet', 'H5.2 Dapur', 'H5.3 Toilet'],
            'Blok E': ['E21 Office', 'E22 Office', 'E7.1 Toilet', 'E7.2 Toilet', 'E8.1 Toilet', 'E8.2 Toilet', 'E9.1 Toilet', 'E9.2 Toilet', 'E10.3 Toilet', 'E10.4 Toilet']
        };

        function showNotification(message, isSuccess = false) {
            const notification = document.getElementById('notification');
            if (notification) {
                notification.textContent = message;
                notification.className = `notification ${isSuccess ? 'success' : ''}`;
                notification.style.display = 'block';
                setTimeout(() => {
                    notification.style.display = 'none';
                    notification.className = 'notification';
                }, 5000);
            } else {
                console.error('Elemen notification tidak ditemukan');
            }
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function toggleTheme() {
            const body = document.body;
            const themeIcon = document.getElementById('themeIcon');
            if (body.classList.contains('dark-theme')) {
                body.classList.remove('dark-theme');
                body.classList.add('light-theme');
                themeIcon.classList.remove('fa-sun');
                themeIcon.classList.add('fa-moon');
                localStorage.setItem('theme', 'light');
            } else {
                body.classList.remove('light-theme');
                body.classList.add('dark-theme');
                themeIcon.classList.remove('fa-moon');
                themeIcon.classList.add('fa-sun');
                localStorage.setItem('theme', 'dark');
            }
        }

        function switchPage(pageId) {
            document.querySelectorAll('#mainPage, #meterPage, #damagePage, #estimationPage, #educationPage, #dataManagementPage').forEach(page => {
                page.style.display = 'none';
            });
            document.getElementById(pageId).style.display = 'block';
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.toggle('active', item.dataset.page === pageId);
            });
            if (pageId === 'educationPage') {
                loadEducationContent();
            }
            if (pageId === 'dataManagementPage' && currentNIK !== 'CA00383') {
                showNotification('Hanya NIK CA00383 yang dapat mengakses manajemen data.');
                switchPage('mainPage');
            }
        }

        function login() {
            const nikInput = document.getElementById('nikInput');
            const nikValue = nikInput.value.trim().toUpperCase();
            const user = users.find(u => u.nik === nikValue);
            if (user) {
                currentNIK = nikValue;
                currentUserName = user.name;
                document.getElementById('loginPage').style.display = 'none';
                switchPage('mainPage');
                showNotification(`Selamat datang, ${currentUserName}!`, true);
                updateShiftInfo();
                updateGreeting();
                populateFilters();
                listenReports(1);
                ['meterGreeting', 'damageGreeting', 'estimationGreeting', 'educationGreeting', 'dataManagementGreeting'].forEach(id => {
                    document.getElementById(id).textContent = document.getElementById('greeting').textContent;
                });
                if (currentNIK === 'CA00383') {
                    document.getElementById('dataManagementToggle').style.display = 'block';
                    document.getElementById('dataManagementToggle').addEventListener('click', () => switchPage('dataManagementPage'));
                }
            } else {
                showNotification('NIK tidak valid! Silakan masukkan NIK yang terdaftar.');
            }
        }

        function updateGreeting() {
            const now = new Date();
            const hour = now.getHours();
            let greetingText = '';
            if ((hour >= 19 && hour <= 23) || (hour >= 0 && hour < 5)) {
                greetingText = `Selamat Malam, ${currentUserName}!`;
            } else if (hour >= 5 && hour < 8) {
                greetingText = `Selamat Pagi, ${currentUserName}!`;
            } else if (hour >= 8 && hour < 17) {
                greetingText = `Selamat Siang, ${currentUserName}!`;
            } else {
                greetingText = `Selamat Sore, ${currentUserName}!`;
            }
            document.getElementById('greeting').textContent = greetingText;
            ['meterGreeting', 'damageGreeting', 'estimationGreeting', 'educationGreeting', 'dataManagementGreeting'].forEach(id => {
                document.getElementById(id).textContent = greetingText;
            });
        }

        function updateShiftInfo() {
            const now = new Date();
            const hour = now.getHours();
            let shiftInfo = 'Di luar jam shift';
            shifts.forEach(shift => {
                if (hour >= shift.start || (shift.start > shift.end && hour < shift.end)) {
                    shiftInfo = `${shift.name} (${shift.startInput}-${shift.endOutput})`;
                }
            });
            document.getElementById('shiftInfo').textContent = shiftInfo;
        }

        function updateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('id-ID');
            updateShiftInfo();
            updateGreeting();
        }

        function switchType(type) {
            currentType = type;
            document.querySelectorAll('.switch-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`switch${type.charAt(0).toUpperCase() + type.slice(1)}`).classList.add('active');
            const saveButton = document.getElementById('saveChecklistButton');
            saveButton.textContent = 'Simpan Checklist';
            delete saveButton.dataset.editId;
            document.getElementById('checklistForm').reset();
        }

        function showEditForm(checklist) {
            if (checklist.nik !== currentNIK) {
                showNotification('Anda tidak memiliki izin untuk mengedit laporan ini.');
                return;
            }
            currentType = checklist.shift || 'custom';
            document.querySelectorAll('.switch-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`switch${currentType.charAt(0).toUpperCase() + currentType.slice(1)}`).classList.add('active');
            document.getElementById('bakRO').value = checklist.bakRO || '';
            document.getElementById('tinggiRO').value = checklist.tinggiRO || '';
            document.getElementById('bakWWTP').value = checklist.bakWWTP || '';
            document.getElementById('tinggiWWTP').value = checklist.tinggiWWTP || '';
            document.getElementById('pompa').value = checklist.pompa || '';
            document.getElementById('tinggiPDAM').value = checklist.tinggiPDAM || '';
            document.getElementById('statusPDAM').value = checklist.statusPDAM || '';
            document.getElementById('hydrantStatus').value = checklist.hydrantStatus || '';
            document.getElementById('supplyPDAM').value = checklist.supplyPDAM || '';
            document.getElementById('meterIndukPDAM').value = checklist.meterIndukPDAM || '';
            document.getElementById('meterIndukWTP').value = checklist.meterIndukWTP || '';
            document.getElementById('PDAM').value = checklist.PDAM || '';
            document.getElementById('flowPDAM').value = checklist.flowPDAM || '';
            document.getElementById('catatan').value = checklist.catatan || '';
            const saveButton = document.getElementById('saveChecklistButton');
            saveButton.textContent = 'Update Checklist';
            saveButton.dataset.editId = checklist.id;
            document.getElementById('checklistFormContainer').scrollIntoView({ behavior: 'smooth' });
        }

        async function saveChecklist(event) {
            event.preventDefault();
            const saveButton = document.getElementById('saveChecklistButton');
            saveButton.classList.add('loading');
            const now = new Date();
            const hour = now.getHours();
            const minute = now.getMinutes();
            const dateStr = now.toLocaleDateString('id-ID');
            let currentShift = null;
            if (currentType !== 'custom') {
                shifts.forEach(shift => {
                    if (hour >= shift.start || (shift.start > shift.end && hour < shift.end)) {
                        currentShift = shift;
                    }
                });
            }

            if (currentType !== 'custom' && !currentShift) {
                showNotification('Checklist masuk/pulang hanya dapat dilakukan selama jam shift!');
                saveButton.classList.remove('loading');
                return;
            }
            
            if (currentType !== 'custom') {
                const [startInputHour, startInputMinute] = currentShift.startInput.split(':').map(Number);
                const [endInputHour, endInputMinute] = currentShift.endInput.split(':').map(Number);
                const [startOutputHour, startOutputMinute] = currentShift.startOutput.split(':').map(Number);
                const [endOutputHour, endOutputMinute] = currentShift.endOutput.split(':').map(Number);

                const isValidMasuk = currentType === 'masuk' &&
                    ((hour === startInputHour && minute >= startInputMinute && (hour < endInputHour || (hour === endInputHour && minute <= endInputMinute))) ||
                     (startInputHour > endInputHour && (hour >= startInputHour || hour < endInputHour || (hour === endInputHour && minute <= endInputMinute))));

                const isValidPulang = currentType === 'pulang' &&
                    ((hour === startOutputHour && minute >= startOutputMinute && (hour < endOutputHour || (hour === endOutputHour && minute <= endOutputMinute))) ||
                     (startOutputHour > endOutputHour && (hour >= startOutputHour || hour < endOutputHour || (hour === endOutputHour && minute <= endOutputMinute))));

                if (!isValidMasuk && !isValidPulang) {
                    showNotification(`Checklist ${currentType} untuk ${currentShift.name} hanya dapat dilakukan pada ${currentType === 'masuk' ? `${currentShift.startInput}-${currentShift.endInput}` : `${currentShift.startOutput}-${currentShift.endOutput}`}. Silakan coba lagi pada waktu yang sesuai.`);
                    saveButton.classList.remove('loading');
                    return;
                }
            }

            const user = users.find(u => u.nik === currentNIK);
            const data = {
                nik: currentNIK,
                name: user ? user.name : 'Unknown',
                date: dateStr,
                time: now.toLocaleTimeString('id-ID'),
                shift: currentType,
                shiftName: currentType === 'custom' ? 'Custom' : currentShift ? currentShift.name : 'Unknown',
                bakRO: document.getElementById('bakRO').value,
                tinggiRO: parseFloat(document.getElementById('tinggiRO').value) || 0,
                bakWWTP: document.getElementById('bakWWTP').value,
                tinggiWWTP: parseFloat(document.getElementById('tinggiWWTP').value) || 0,
                pompa: document.getElementById('pompa').value,
                tinggiPDAM: parseFloat(document.getElementById('tinggiPDAM').value) || 0,
                statusPDAM: document.getElementById('statusPDAM').value,
                hydrantStatus: document.getElementById('hydrantStatus').value,
                supplyPDAM: document.getElementById('supplyPDAM').value,
                meterIndukPDAM: parseFloat(document.getElementById('meterIndukPDAM').value) || 0,
                meterIndukWTP: parseFloat(document.getElementById('meterIndukWTP').value) || 0,
                PDAM: parseFloat(document.getElementById('PDAM').value) || 0,
                flowPDAM: parseFloat(document.getElementById('flowPDAM').value) || 0,
                catatan: document.getElementById('catatan').value || '',
                createdAt: serverTimestamp()
            };

            const required = ['bakRO', 'tinggiRO', 'bakWWTP', 'tinggiWWTP', 'pompa', 'tinggiPDAM', 'statusPDAM', 'hydrantStatus', 'supplyPDAM', 'meterIndukPDAM', 'meterIndukWTP', 'PDAM', 'flowPDAM'];
            const missing = required.filter(field => !data[field] && data[field] !== 0);

            if (missing.length > 0) {
                showNotification('Mohon lengkapi semua field yang wajib diisi!');
                saveButton.classList.remove('loading');
                return;
            }

            try {
                if (saveButton.dataset.editId) {
                    await updateDoc(doc(db, 'checklists', saveButton.dataset.editId), data);
                    showNotification('Checklist berhasil diperbarui!', true);
                    saveButton.textContent = 'Simpan Checklist';
                    delete saveButton.dataset.editId;
                } else {
                    await addDoc(collection(db, 'checklists'), data);
                    showNotification('Checklist berhasil disimpan!', true);
                }
                document.getElementById('checklistForm').reset();
            } catch (error) {
                console.error('Gagal menyimpan checklist:', error);
                showNotification(`Gagal menyimpan checklist: ${error.message}`);
            } finally {
                saveButton.classList.remove('loading');
            }
        }

        async function getLastVisibleDoc(collectionName, page, limit) {
            const q = query(collection(db, collectionName), orderBy('createdAt', 'desc'), limit(limit * (page - 1)));
            const snapshot = await getDocs(q);
            return snapshot.docs[snapshot.docs.length - 1];
        }

        async function listenReports(page = 1) {
            const filterDate = document.getElementById('filterDate').value;
            const filterShift = document.getElementById('filterShift').value;
            const filterNIK = document.getElementById('filterNIK').value;
            const reportBody = document.getElementById('reportBody');
            const pagination = document.getElementById('reportPagination');

            let q = query(collection(db, 'checklists'), orderBy('createdAt', 'desc'), limit(ITEMS_PER_PAGE));
            if (page > 1) {
                const lastVisible = await getLastVisibleDoc('checklists', page, ITEMS_PER_PAGE);
                q = query(q, startAfter(lastVisible));
            }
            if (filterDate) q = query(q, where('date', '==', filterDate));
            if (filterShift) q = query(q, where('shift', '==', filterShift));
            if (filterNIK) q = query(q, where('nik', '==', filterNIK));

            onSnapshot(q, async (snapshot) => {
                reportBody.innerHTML = '';
                const checklists = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (checklists.length === 0) {
                    reportBody.innerHTML = '<tr><td colspan="8">Tidak ada data checklist.</td></tr>';
                } else {
                    checklists.forEach(c => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${c.date || '-'}</td>
                            <td>${c.time || '-'}</td>
                            <td>${c.shift ? c.shift.toUpperCase() : '-'} ${c.shiftName !== 'Custom' ? '(' + (c.shiftName || '-') + ')' : ''}</td>
                            <td>${c.nik || '-'} - ${c.name || '-'}</td>
                            <td>${c.catatan || '-'}</td>
                            <td><button class="detail-btn" data-detail='${JSON.stringify(c).replace(/'/g, "&apos;")}'>Lihat</button></td>
                            <td><button class="whatsapp-btn" data-detail='${JSON.stringify(c).replace(/'/g, "&apos;")}'><i class="fab fa-whatsapp"></i> Share</button></td>
                            <td><button class="edit-btn" data-detail='${JSON.stringify(c).replace(/'/g, "&apos;")}' ${c.nik !== currentNIK ? 'disabled' : ''}>Edit</button></td>
                        `;
                        reportBody.appendChild(row);
                    });
                }

                const totalDocs = (await getDocs(query(collection(db, 'checklists')))).size;
                pagination.innerHTML = `
                    <button onclick="listenReports(${page - 1})" ${page === 1 ? 'disabled' : ''}>Sebelumnya</button>
                    <span>Halaman ${page}</span>
                    <button onclick="listenReports(${page + 1})" ${page * ITEMS_PER_PAGE >= totalDocs ? 'disabled' : ''}>Selanjutnya</button>
                `;
            }, (error) => {
                console.error('Error fetching checklists:', error);
                showNotification('Gagal memuat laporan checklist.');
            });
        }

        async function populateFilters() {
            const filterDate = document.getElementById('filterDate');
            const filterNIK = document.getElementById('filterNIK');
            const snapshot = await getDocs(query(collection(db, 'checklists'), orderBy('date', 'desc')));
            const checklists = snapshot.docs.map(doc => doc.data());
            const dates = [...new Set(checklists.map(c => c.date))].sort((a, b) => new Date(b) - new Date(a));
            const nikOptions = users.map(u => `<option value="${u.nik}">${u.nik} - ${u.name}</option>`);
            filterDate.innerHTML = '<option value="">Semua Tanggal</option>' + dates.map(d => `<option value="${d}">${d}</option>`).join('');
            filterNIK.innerHTML = '<option value="">Semua Pengguna</option>' + nikOptions.join('');
        }

        function showDetail(data) {
            const modal = document.getElementById('detailModal');
            const modalContent = document.getElementById('modalContent');
            const modalOverlay = document.getElementById('modalOverlay');
            modalContent.innerHTML = `
                <ul>
                    <li><strong>Tanggal:</strong> ${data.date || '-'}</li>
                    <li><strong>Waktu:</strong> ${data.time || '-'}</li>
                    <li><strong>Shift:</strong> ${data.shift ? data.shift.toUpperCase() : '-'} ${data.shiftName !== 'Custom' ? '(' + (data.shiftName || '-') + ')' : ''}</li>
                    <li><strong>Penginput:</strong> ${data.nik || '-'} - ${data.name || '-'}</li>
                    <li><strong>1. Bak Distribusi RO:</strong> ${data.bakRO || '-'} (Ketinggian: ${data.tinggiRO || 0} cm)</li>
                    <li><strong>2. Bak Distribusi WWTP:</strong> ${data.bakWWTP || '-'} (Ketinggian: ${data.tinggiWWTP || 0} cm)</li>
                    <li><strong>3. Pompa Transfer:</strong> ${data.pompa || '-'}</li>
                    <li><strong>4. Bak Input PDAM:</strong> ${data.statusPDAM || '-'} (Ketinggian: ${data.tinggiPDAM || 0} cm)</li>
                    <li><strong>5. Hydrant Status:</strong> ${data.hydrantStatus || '-'}</li>
                    <li><strong>6. Supply Air PDAM:</strong> ${data.supplyPDAM || '-'}</li>
                    <li><strong>7. Meter Induk PDAM:</strong> ${data.meterIndukPDAM || 0} m³</li>
                    <li><strong>8. Meter Induk WTP:</strong> ${data.meterIndukWTP || 0} m³</li>
                    <li><strong>9. Flow Input PDAM:</strong> ${data.PDAM || 0} m³</li>
                    <li><strong>10. Flow Rate PDAM:</strong> ${data.flowPDAM || 0} m³/j</li>
                    <li><strong>11. Catatan:</strong> ${data.catatan || '-'}</li>
                </ul>
            `;
            modal.style.display = 'block';
            modalOverlay.style.display = 'block';
        }

        function closeModal() {
            document.getElementById('detailModal').style.display = 'none';
            document.getElementById('modalOverlay').style.display = 'none';
        }

        function shareChecklist(data) {
            const message = encodeURIComponent(`
Checklist Sistem Air
• Tanggal: ${data.date || '-'}
• Waktu: ${data.time || '-'}
• Shift: ${data.shift ? data.shift.toUpperCase() : '-'} ${data.shiftName !== 'Custom' ? '(' + (data.shiftName || '-') + ')' : ''}
• Penginput: ${data.nik || '-'} - ${data.name || '-'}

1. Bak Distribusi RO
   • Status: ${data.bakRO || '-'}
   • Ketinggian: ${data.tinggiRO || 0} cm

2. Bak Distribusi WWTP
   • Status: ${data.bakWWTP || '-'}
   • Ketinggian: ${data.tinggiWWTP || 0} cm

3. Pompa Transfer
   • Status: ${data.pompa || '-'}

4. Bak Input PDAM
   • Ketinggian: ${data.tinggiPDAM || 0} cm
   • Status: ${data.statusPDAM || '-'}
   • Hydrant Status: ${data.hydrantStatus || '-'}

5. Supply Air PDAM
   • Status: ${data.supplyPDAM || '-'}
   • Meter Induk PDAM: ${data.meterIndukPDAM || 0}
   • Meter Induk WTP: ${data.meterIndukWTP || 0}
   • Flow Input: ${data.PDAM || 0} m³
   • Flow Rate: ${data.flowPDAM || 0} m³/j

• Catatan: ${data.catatan || '-'}`);
            const url = `https://wa.me/?text=${message}`;
            window.open(url, '_blank');
        }

        async function saveMeter(event) {
            event.preventDefault();
            const saveButton = document.getElementById('saveMeterButton');
            saveButton.classList.add('loading');
            const now = new Date();
            const data = {
                nik: currentNIK,
                name: currentUserName,
                date: now.toLocaleDateString('id-ID'),
                time: now.toLocaleTimeString('id-ID'),
                block: document.getElementById('meterBlock').value,
                location: document.getElementById('meterLocation').value,
                meterReading: parseFloat(document.getElementById('meterReading').value) || 0,
                notes: document.getElementById('meterNotes').value || '',
                createdAt: serverTimestamp()
            };

            const required = ['block', 'location', 'meterReading'];
            const missing = required.filter(field => !data[field] && data[field] !== 0);

            if (missing.length > 0) {
                showNotification('Mohon lengkapi semua field yang wajib diisi!');
                saveButton.classList.remove('loading');
                return;
            }

            try {
                await addDoc(collection(db, 'meters'), data);
                showNotification('Data meter berhasil disimpan!', true);
                document.getElementById('meterForm').reset();
                document.getElementById('actualUsage').textContent = '';
                listenMeterReports(1);
            } catch (error) {
                console.error('Gagal menyimpan data meter:', error);
                showNotification(`Gagal menyimpan data meter: ${error.message}`);
            } finally {
                saveButton.classList.remove('loading');
            }
        }

        async function listenMeterReports(page = 1) {
            const filterBlock = document.getElementById('meterFilterBlock').value;
            const filterDate = document.getElementById('meterFilterDate').value;
            const reportBody = document.getElementById('meterReportBody');
            const pagination = document.getElementById('meterPagination');

            let q = query(collection(db, 'meters'), orderBy('createdAt', 'desc'), limit(ITEMS_PER_PAGE));
            if (page > 1) {
                const lastVisible = await getLastVisibleDoc('meters', page, ITEMS_PER_PAGE);
                q = query(q, startAfter(lastVisible));
            }
            if (filterBlock) q = query(q, where('block', '==', filterBlock));
            if (filterDate) q = query(q, where('date', '==', filterDate));

            onSnapshot(q, async (snapshot) => {
                reportBody.innerHTML = '';
                const meters = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (meters.length === 0) {
                    reportBody.innerHTML = '<tr><td colspan="8">Tidak ada data meter.</td></tr>';
                } else {
                    for (const m of meters) {
                        const actualUsage = await calculateActualUsage(m.block, m.location, m.meterReading, m.date);
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${m.date || '-'}</td>
                            <td>${m.time || '-'}</td>
                            <td>${m.block || '-'}</td>
                            <td>${m.location || '-'}</td>
                            <td>${m.meterReading || 0} m³</td>
                            <td>${actualUsage !== null ? actualUsage.toFixed(2) + ' m³' : '-'}</td>
                            <td>${m.notes || '-'}</td>
                            <td><button class="whatsapp-btn" data-detail='${JSON.stringify(m).replace(/'/g, "&apos;")}'><i class="fab fa-whatsapp"></i> Share</button></td>
                        `;
                        reportBody.appendChild(row);
                    }
                }

                const totalDocs = (await getDocs(query(collection(db, 'meters')))).size;
                pagination.innerHTML = `
                    <button onclick="listenMeterReports(${page - 1})" ${page === 1 ? 'disabled' : ''}>Sebelumnya</button>
                    <span>Halaman ${page}</span>
                    <button onclick="listenMeterReports(${page + 1})" ${page * ITEMS_PER_PAGE >= totalDocs ? 'disabled' : ''}>Selanjutnya</button>
                `;
            }, (error) => {
                console.error('Error fetching meters:', error);
                showNotification('Gagal memuat laporan meter.');
            });
        }

        async function calculateActualUsage(block, location, currentReading, currentDate) {
            const q = query(
                collection(db, 'meters'),
                where('block', '==', block),
                where('location', '==', location),
                where('date', '<', currentDate),
                orderBy('date', 'desc'),
                limit(1)
            );
            const snapshot = await getDocs(q);
            if (snapshot.empty) return null;
            const previous = snapshot.docs[0].data();
            return currentReading - previous.meterReading;
        }

        function shareMeter(data) {
            const message = encodeURIComponent(`
Laporan Meter Lapangan
• Tanggal: ${data.date || '-'}
• Waktu: ${data.time || '-'}
• Blok: ${data.block || '-'}
• Lokasi: ${data.location || '-'}
• Angka Meter: ${data.meterReading || 0} m³
• Catatan: ${data.notes || '-'}`);
            const url = `https://wa.me/?text=${message}`;
            window.open(url, '_blank');
        }

        async function saveDamage(event) {
            event.preventDefault();
            const saveButton = document.getElementById('saveDamageButton');
            saveButton.classList.add('loading');
            const now = new Date();
            const data = {
                nik: currentNIK,
                name: currentUserName,
                date: now.toLocaleDateString('id-ID'),
                time: now.toLocaleTimeString('id-ID'),
                damageType: document.getElementById('damageType').value,
                block: document.getElementById('damageBlock').value,
                location: document.getElementById('damageLocation').value,
                specific: document.getElementById('damageSpecific').value,
                notes: document.getElementById('damageNotes').value || '',
                createdAt: serverTimestamp()
            };

            const required = ['damageType', 'block', 'location', 'specific'];
            const missing = required.filter(field => !data[field]);

            if (missing.length > 0) {
                showNotification('Mohon lengkapi semua field yang wajib diisi!');
                saveButton.classList.remove('loading');
                return;
            }

            try {
                await addDoc(collection(db, 'damages'), data);
                showNotification('Laporan kerusakan berhasil disimpan!', true);
                document.getElementById('damageForm').reset();
                listenDamageReports(1);
            } catch (error) {
                console.error('Gagal menyimpan laporan kerusakan:', error);
                showNotification(`Gagal menyimpan laporan kerusakan: ${error.message}`);
            } finally {
                saveButton.classList.remove('loading');
            }
        }

        async function listenDamageReports(page = 1) {
            const filterBlock = document.getElementById('damageFilterBlock').value;
            const filterDate = document.getElementById('damageFilterDate').value;
            const reportBody = document.getElementById('damageReportBody');
            const pagination = document.getElementById('damagePagination');

            let q = query(collection(db, 'damages'), orderBy('createdAt', 'desc'), limit(ITEMS_PER_PAGE));
            if (page > 1) {
                const lastVisible = await getLastVisibleDoc('damages', page, ITEMS_PER_PAGE);
                q = query(q, startAfter(lastVisible));
            }
            if (filterBlock) q = query(q, where('block', '==', filterBlock));
            if (filterDate) q = query(q, where('date', '==', filterDate));

            onSnapshot(q, async (snapshot) => {
                reportBody.innerHTML = '';
                const damages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (damages.length === 0) {
                    reportBody.innerHTML = '<tr><td colspan="7">Tidak ada data kerusakan.</td></tr>';
                } else {
                    damages.forEach(d => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${d.date || '-'}</td>
                            <td>${d.damageType || '-'}</td>
                            <td>${d.block || '-'}</td>
                            <td>${d.location || '-'}</td>
                            <td>${d.specific || '-'}</td>
                            <td>${d.notes || '-'}</td>
                            <td><button class="whatsapp-btn" data-detail='${JSON.stringify(d).replace(/'/g, "&apos;")}'><i class="fab fa-whatsapp"></i> Share</button></td>
                        `;
                        reportBody.appendChild(row);
                    });
                }

                const totalDocs = (await getDocs(query(collection(db, 'damages')))).size;
                pagination.innerHTML = `
                    <button onclick="listenDamageReports(${page - 1})" ${page === 1 ? 'disabled' : ''}>Sebelumnya</button>
                    <span>Halaman ${page}</span>
                    <button onclick="listenDamageReports(${page + 1})" ${page * ITEMS_PER_PAGE >= totalDocs ? 'disabled' : ''}>Selanjutnya</button>
                `;
            }, (error) => {
                console.error('Error fetching damages:', error);
                showNotification('Gagal memuat laporan kerusakan.');
            });
        }

        function shareDamage(data) {
            const message = encodeURIComponent(`
Laporan Kerusakan
• Tanggal: ${data.date || '-'}
• Jenis Kerusakan: ${data.damageType || '-'}
• Blok: ${data.block || '-'}
• Lokasi: ${data.location || '-'}
• Spesifik: ${data.specific || '-'}
• Catatan: ${data.notes || '-'}`);
            const url = `https://wa.me/?text=${message}`;
            window.open(url, '_blank');
        }

        async function calculateEstimation(event) {
    event.preventDefault();
    const calculateButton = document.getElementById('calculateEstimationButton');
    calculateButton.classList.add('loading');
    try {
        let avgUsage, totalUsage, tankStatus, supplyStatus, projectedUsage;

        // Parameter kapasitas bak (dalam m³)
        const TANK_CAPACITY_RO = 1200; // 5m × 20m × 12m = 1200 m³ (1.200.000 liter)
        const TANK_CAPACITY_WWTP = 45; // 3m × 5m × 3m = 45 m³ (45.000 liter)
        const TANK_CAPACITY_PDAM = 1200; // 5m × 20m × 12m = 1200 m³ (1.200.000 liter)
        const TANK_HEIGHT_RO = 500; // Tinggi maksimum RO (cm)
        const TANK_HEIGHT_WWTP = 300; // Tinggi maksimum WWTP (cm)
        const TANK_HEIGHT_PDAM = 500; // Tinggi maksimum PDAM (cm)
        const SAFE_LEVEL = 0.3; // Tingkat aman bak (30% dari kapasitas)

        if (estimationMode === 'auto') {
            const block = document.getElementById('estimationBlock').value;
            const date = document.getElementById('estimationDate').value;
            const timeRange = parseInt(document.getElementById('estimationTimeRange').value);

            if (!block || !date || !timeRange) {
                showNotification('Mohon lengkapi semua field!');
                calculateButton.classList.remove('loading');
                return;
            }

            // Ambil data checklist dan meter untuk blok dan tanggal tertentu
            let qChecklist = query(collection(db, 'checklists'), where('date', '==', date));
            let qMeter = query(collection(db, 'meters'), where('block', '==', block), where('date', '==', date));
            const checklistSnapshot = await getDocs(qChecklist);
            const meterSnapshot = await getDocs(qMeter);

            const checklists = checklistSnapshot.docs.map(doc => doc.data());
            const meters = meterSnapshot.docs.map(doc => doc.data());

            // Estimasi berdasarkan data checklist
            const flowPDAM = checklists.reduce((sum, c) => sum + (c.flowPDAM || 0), 0) / (checklists.length || 1);
            const tinggiRO = checklists.reduce((sum, c) => sum + (c.tinggiRO || 0), 0) / (checklists.length || 1);
            const tinggiWWTP = checklists.reduce((sum, c) => sum + (c.tinggiWWTP || 0), 0) / (checklists.length || 1);
            const tinggiPDAM = checklists.reduce((sum, c) => sum + (c.tinggiPDAM || 0), 0) / (checklists.length || 1);

            // Estimasi berdasarkan data meter
            const meterReadings = meters.map(m => m.meterReading).sort((a, b) => a - b);
            const usageDiff = meterReadings.length > 1 ? meterReadings[meterReadings.length - 1] - meterReadings[0] : 0;

            // Menghitung persentase kapasitas bak
            const roPercentage = (tinggiRO / TANK_HEIGHT_RO) * 100;
            const wwtpPercentage = (tinggiWWTP / TANK_HEIGHT_WWTP) * 100;
            const pdamPercentage = (tinggiPDAM / TANK_HEIGHT_PDAM) * 100;

            // Status bak
            tankStatus = `RO: ${roPercentage.toFixed(2)}% (Kapasitas: ${TANK_CAPACITY_RO} m³), WWTP: ${wwtpPercentage.toFixed(2)}% (Kapasitas: ${TANK_CAPACITY_WWTP} m³), PDAM: ${pdamPercentage.toFixed(2)}% (Kapasitas: ${TANK_CAPACITY_PDAM} m³)`;

            // Status kecukupan suplai
            const isTankSafe = roPercentage >= SAFE_LEVEL * 100 && wwtpPercentage >= SAFE_LEVEL * 100 && pdamPercentage >= SAFE_LEVEL * 100;
            const isFlowAdequate = flowPDAM >= usageDiff / (timeRange || 1);
            supplyStatus = isTankSafe && isFlowAdequate ? 'Memadai' : 'Perhatian: Suplai atau bak di bawah aman';

            // Perhitungan pemakaian
            avgUsage = usageDiff / (timeRange || 1); // m³/jam
            totalUsage = avgUsage * timeRange; // m³
            projectedUsage = avgUsage * 24; // Proyeksi untuk 24 jam

            // Visualisasi dengan Chart.js
            const labels = Array.from({ length: timeRange }, (_, i) => `Jam ${i + 1}`);
            const data = Array.from({ length: timeRange }, () => avgUsage);
            updateChart(labels, data);
        } else {
            // Estimasi manual
            const tinggiRO = parseFloat(document.getElementById('manualTinggiRO').value) || 0;
            const tinggiWWTP = parseFloat(document.getElementById('manualTinggiWWTP').value) || 0;
            const tinggiPDAM = parseFloat(document.getElementById('manualTinggiPDAM').value) || 0;
            const flowPDAM = parseFloat(document.getElementById('manualFlowPDAM').value) || 0;
            const meterReadings = [
                parseFloat(document.getElementById('meterReading1').value) || 0,
                parseFloat(document.getElementById('meterReading2').value) || 0,
                parseFloat(document.getElementById('meterReading3').value) || 0,
                parseFloat(document.getElementById('meterReading4').value) || 0
            ].filter(v => v > 0);

            if (meterReadings.length < 2) {
                showNotification('Masukkan setidaknya dua pembacaan meter untuk estimasi manual!');
                calculateButton.classList.remove('loading');
                return;
            }

            // Menghitung persentase kapasitas bak
            const roPercentage = (tinggiRO / TANK_HEIGHT_RO) * 100;
            const wwtpPercentage = (tinggiWWTP / TANK_HEIGHT_WWTP) * 100;
            const pdamPercentage = (tinggiPDAM / TANK_HEIGHT_PDAM) * 100;

            // Status bak
            tankStatus = `RO: ${roPercentage.toFixed(2)}% (Kapasitas: ${TANK_CAPACITY_RO} m³), WWTP: ${wwtpPercentage.toFixed(2)}% (Kapasitas: ${TANK_CAPACITY_WWTP} m³), PDAM: ${pdamPercentage.toFixed(2)}% (Kapasitas: ${TANK_CAPACITY_PDAM} m³)`;

            // Perhitungan pemakaian
            const usageDiff = meterReadings[meterReadings.length - 1] - meterReadings[0];
            avgUsage = usageDiff / 4; // Asumsi 4 jam interval
            totalUsage = usageDiff; // Total berdasarkan perbedaan
            projectedUsage = avgUsage * 24; // Proyeksi untuk 24 jam

            // Status kecukupan suplai
            const isTankSafe = roPercentage >= SAFE_LEVEL * 100 && wwtpPercentage >= SAFE_LEVEL * 100 && pdamPercentage >= SAFE_LEVEL * 100;
            const isFlowAdequate = flowPDAM >= avgUsage;
            supplyStatus = isTankSafe && isFlowAdequate ? 'Memadai' : 'Perhatian: Suplai atau bak di bawah aman';

            // Visualisasi dengan Chart.js
            const labels = ['Pembacaan 1', 'Pembacaan 2', 'Pembacaan 3', 'Pembacaan 4'].slice(0, meterReadings.length);
            updateChart(labels, meterReadings);
        }

        document.getElementById('avgUsage').textContent = avgUsage.toFixed(2);
        document.getElementById('totalUsage').textContent = totalUsage.toFixed(2);
        document.getElementById('tankStatus').textContent = tankStatus;
        document.getElementById('supplyStatus').textContent = supplyStatus;
        document.getElementById('projectedUsage').textContent = projectedUsage.toFixed(2);
        document.getElementById('estimationResult').style.display = 'block';
        showNotification('Estimasi pemakaian berhasil dihitung!', true);
    } catch (error) {
        console.error('Gagal menghitung estimasi:', error);
        showNotification(`Gagal menghitung estimasi: ${error.message}`);
    } finally {
        calculateButton.classList.remove('loading');
    }
}

        function updateChart(labels, data) {
            const ctx = document.getElementById('usageChart').getContext('2d');
            if (usageChart) {
                usageChart.destroy();
            }
            usageChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Pemakaian Air (m³)',
                        data: data,
                        borderColor: '#4CAF50',
                        backgroundColor: 'rgba(76, 175, 80, 0.2)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Pemakaian (m³)' }
                        },
                        x: {
                            title: { display: true, text: 'Waktu' }
                        }
                    }
                }
            });
        }

        const educationData = [
            {
                category: "K3",
                title: "Tips Aman Bekerja di Area WTP",
                description: "1. Gunakan APD lengkap (helm, sarung tangan, sepatu anti-slip). 2. Pastikan ventilasi memadai untuk mencegah paparan gas berbahaya. 3. Lakukan inspeksi rutin terhadap peralatan listrik untuk mencegah korsleting. 4. Ikuti prosedur lockout-tagout (LOTO) saat maintenance pompa atau pipa. 5. Selalu siapkan jalur evakuasi di area WTP.",
                source: "https://www.ilo.org/jakarta/areasofwork/WCMS_627455/lang--en/index.htm"
            },
            {
                category: "Water Treatment Plant",
                title: "Optimalisasi Pengolahan Air Domestik",
                description: "1. Gunakan koagulan seperti PAC (Polyaluminium Chloride) untuk mengendapkan kotoran. 2. Pastikan dosis kimia sesuai dengan volume air (biasanya 5-10 ppm). 3. Lakukan backwash filter secara rutin setiap 48 jam untuk mencegah penyumbatan. 4. Monitor parameter pH dan kekeruhan setiap shift. 5. Gunakan UV sterilizer untuk memastikan air bebas bakteri.",
                source: "https://www.who.int/water_sanitation_health/publications/drinking-water-quality-guidelines/en/"
            },
            {
                category: "Water Treatment Plant",
                title: "Pemeliharaan Sistem RO untuk Air Domestik",
                description: "1. Ganti membran RO setiap 1-2 tahun tergantung pada kualitas air baku. 2. Bersihkan pre-filter setiap bulan untuk mencegah penurunan tekanan. 3. Monitor TDS (Total Dissolved Solids) untuk memastikan kualitas air keluaran di bawah 50 ppm. 4. Pastikan pompa tekanan tinggi beroperasi pada 10-15 bar. 5. Catat semua parameter operasional untuk analisis tren.",
                source: "https://www.lenntech.com/processes/reverse-osmosis.htm"
            },
            {
                category: "Baku Mutu Air",
                title: "Standar Kualitas Air Minum",
                description: "Kualitas air minum harus memenuhi parameter pH 6.5-8.5, TDS < 500 ppm, dan bebas dari kontaminan bakteri seperti E. coli. Lakukan pengujian rutin menggunakan alat TDS meter dan pH meter.",
                source: "https://www.who.int/water_sanitation_health/publications/drinking-water-quality-guidelines/en/"
            }
        ];

        async function importEducationData() {
            for (const data of educationData) {
                try {
                    const q = query(
                        collection(db, 'education'),
                        where('title', '==', data.title),
                        where('category', '==', data.category)
                    );
                    const snapshot = await getDocs(q);
                    if (snapshot.empty) {
                        await addDoc(collection(db, 'education'), { ...data, createdAt: serverTimestamp() });
                        console.log(`Berhasil menambahkan: ${data.title}`);
                    } else {
                        console.log(`Konten ${data.title} sudah ada, dilewati.`);
                    }
                } catch (error) {
                    console.error(`Gagal menambahkan ${data.title}:`, error);
                }
            }
        }

        async function loadEducationContent() {
            const educationContent = document.getElementById('educationContent');
            const searchQuery = document.getElementById('educationSearch').value.toLowerCase();
            const categoryFilter = document.getElementById('educationCategory').value;

            let q = query(collection(db, 'education'), orderBy('createdAt', 'desc'));
            if (categoryFilter) q = query(q, where('category', '==', categoryFilter));

            const snapshot = await getDocs(q);
            educationContent.innerHTML = '';
            let filteredData = snapshot.docs.map(doc => doc.data());

            if (searchQuery) {
                filteredData = filteredData.filter(data => 
                    data.title.toLowerCase().includes(searchQuery) || 
                    data.description.toLowerCase().includes(searchQuery)
                );
            }

            if (filteredData.length === 0) {
                educationContent.innerHTML = '<p>Tidak ada konten edukasi yang ditemukan.</p>';
            } else {
                filteredData.forEach(data => {
                    const accordion = document.createElement('div');
                    accordion.className = 'accordion';
                    accordion.innerHTML = `
                        <div class="accordion-header">
                            <span>${data.title} (${data.category})</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="accordion-content">
                            <p>${data.description}</p>
                            <a href="${data.source}" target="_blank">Baca Selengkapnya</a>
                        </div>
                    `;
                    educationContent.appendChild(accordion);
                });

                document.querySelectorAll('.accordion-header').forEach(header => {
                    header.addEventListener('click', () => {
                        const content = header.nextElementSibling;
                        content.classList.toggle('active');
                        const chevron = header.querySelector('i');
                        chevron.classList.toggle('fa-chevron-down');
                        chevron.classList.toggle('fa-chevron-up');
                    });
                });
            }
        }

        async function deleteData(event) {
            event.preventDefault();
            const deleteButton = document.getElementById('deleteDataButton');
            deleteButton.classList.add('loading');
            const dataType = document.getElementById('dataType').value;
            const deleteDate = document.getElementById('dataDeleteDate').value;

            if (!dataType || !deleteDate) {
                showNotification('Mohon pilih tipe data dan tanggal!');
                deleteButton.classList.remove('loading');
                return;
            }

            if (currentNIK !== 'CA00383') {
                showNotification('Hanya NIK CA00383 yang dapat menghapus data.');
                deleteButton.classList.remove('loading');
                return;
            }

            try {
                const q = query(collection(db, dataType), where('date', '==', deleteDate));
                const snapshot = await getDocs(q);
                if (snapshot.empty) {
                    showNotification('Tidak ada data untuk tanggal tersebut.');
                    deleteButton.classList.remove('loading');
                    return;
                }

                for (const doc of snapshot.docs) {
                    await deleteDoc(doc.ref);
                }
                showNotification(`Data ${dataType} untuk tanggal ${deleteDate} berhasil dihapus!`, true);
                document.getElementById('dataManagementPage').style.display = 'none';
                switchPage('mainPage');
            } catch (error) {
                console.error('Gagal menghapus data:', error);
                showNotification(`Gagal menghapus data: ${error.message}`);
            } finally {
                deleteButton.classList.remove('loading');
            }
        }
        
        function populateBlockLocations(blockSelectId, locationSelectId) {
            const blockSelect = document.getElementById(blockSelectId);
            const locationSelect = document.getElementById(locationSelectId);
            blockSelect.addEventListener('change', () => {
                const block = blockSelect.value;
                locationSelect.innerHTML = '<option value="">Pilih Lokasi...</option>';
                if (block && blockLocations[block]) {
                    blockLocations[block].forEach(loc => {
                        const option = document.createElement('option');
                        option.value = loc;
                        option.textContent = loc;
                        locationSelect.appendChild(option);
                    });
                }
            });
        }

        function populateMeterFilterBlock() {
            const filterBlock = document.getElementById('meterFilterBlock');
            filterBlock.innerHTML = '<option value="">Semua Blok</option>';
            Object.keys(blockLocations).forEach(block => {
                const option = document.createElement('option');
                option.value = block;
                option.textContent = block;
                filterBlock.appendChild(option);
            });
        }

        function populateDamageFilterBlock() {
            const filterBlock = document.getElementById('damageFilterBlock');
            filterBlock.innerHTML = '<option value="">Semua Blok</option>';
            Object.keys(blockLocations).forEach(block => {
                const option = document.createElement('option');
                option.value = block;
                option.textContent = block;
                filterBlock.appendChild(option);
            });
        }

        async function populateMeterFilterDate() {
            const filterDate = document.getElementById('meterFilterDate');
            const snapshot = await getDocs(query(collection(db, 'meters'), orderBy('date', 'desc')));
            const meters = snapshot.docs.map(doc => doc.data());
            const dates = [...new Set(meters.map(m => m.date))].sort((a, b) => new Date(b) - new Date(a));
            filterDate.innerHTML = '<option value="">Semua Tanggal</option>' + dates.map(d => `<option value="${d}">${d}</option>`).join('');
        }

        async function populateDamageFilterDate() {
            const filterDate = document.getElementById('damageFilterDate');
            const snapshot = await getDocs(query(collection(db, 'damages'), orderBy('date', 'desc')));
            const damages = snapshot.docs.map(doc => doc.data());
            const dates = [...new Set(damages.map(d => d.date))].sort((a, b) => new Date(b) - new Date(a));
            filterDate.innerHTML = '<option value="">Semua Tanggal</option>' + dates.map(d => `<option value="${d}">${d}</option>`).join('');
        }

        function toggleEstimationMode(mode) {
            estimationMode = mode;
            document.querySelectorAll('.switch-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`switch${mode.charAt(0).toUpperCase() + mode.slice(1)}Estimation`).classList.add('active');
            document.getElementById('autoEstimationFields').style.display = mode === 'auto' ? 'block' : 'none';
            document.getElementById('manualEstimationFields').style.display = mode === 'manual' ? 'block' : 'none';
            document.getElementById('estimationResult').style.display = 'none';
            if (usageChart) {
                usageChart.destroy();
                usageChart = null;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.body.classList.add(`${savedTheme}-theme`);
            document.getElementById('themeIcon').classList.add(savedTheme === 'dark' ? 'fa-sun' : 'fa-moon');

            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => switchPage(item.dataset.page));
            });
            document.getElementById('loginButton').addEventListener('click', login);
            document.getElementById('checklistForm').addEventListener('submit', saveChecklist);
            document.getElementById('meterForm').addEventListener('submit', saveMeter);
            document.getElementById('damageForm').addEventListener('submit', saveDamage);
            document.getElementById('estimationForm').addEventListener('submit', calculateEstimation);
            document.getElementById('deleteDataButton').addEventListener('click', deleteData);

            document.getElementById('switchMasuk').addEventListener('click', () => switchType('masuk'));
            document.getElementById('switchPulang').addEventListener('click', () => switchType('pulang'));
            document.getElementById('switchCustom').addEventListener('click', () => switchType('custom'));

            document.getElementById('switchAutoEstimation').addEventListener('click', () => toggleEstimationMode('auto'));
            document.getElementById('switchManualEstimation').addEventListener('click', () => toggleEstimationMode('manual'));

            document.getElementById('modalClose').addEventListener('click', closeModal);
            document.getElementById('modalOverlay').addEventListener('click', closeModal);

            document.getElementById('reportTable').addEventListener('click', (e) => {
                if (e.target.classList.contains('detail-btn')) {
                    const data = JSON.parse(e.target.dataset.detail.replace(/&apos;/g, "'"));
                    showDetail(data);
                } else if (e.target.classList.contains('whatsapp-btn') || e.target.parentElement.classList.contains('whatsapp-btn')) {
                    const data = JSON.parse((e.target.dataset.detail || e.target.parentElement.dataset.detail).replace(/&apos;/g, "'"));
                    shareChecklist(data);
                } else if (e.target.classList.contains('edit-btn')) {
                    const data = JSON.parse(e.target.dataset.detail.replace(/&apos;/g, "'"));
                    showEditForm(data);
                }
            });

            document.getElementById('meterTable').addEventListener('click', (e) => {
                if (e.target.classList.contains('whatsapp-btn') || e.target.parentElement.classList.contains('whatsapp-btn')) {
                    const data = JSON.parse((e.target.dataset.detail || e.target.parentElement.dataset.detail).replace(/&apos;/g, "'"));
                    shareMeter(data);
                }
            });

            document.getElementById('damageTable').addEventListener('click', (e) => {
                if (e.target.classList.contains('whatsapp-btn') || e.target.parentElement.classList.contains('whatsapp-btn')) {
                    const data = JSON.parse((e.target.dataset.detail || e.target.parentElement.dataset.detail).replace(/&apos;/g, "'"));
                    shareDamage(data);
                }
            });

            const debouncedListenReports = debounce(listenReports, 300);
            document.getElementById('filterDate').addEventListener('change', () => debouncedListenReports(1));
            document.getElementById('filterShift').addEventListener('change', () => debouncedListenReports(1));
            document.getElementById('filterNIK').addEventListener('change', () => debouncedListenReports(1));

            const debouncedListenMeterReports = debounce(listenMeterReports, 300);
            document.getElementById('meterFilterBlock').addEventListener('change', () => debouncedListenMeterReports(1));
            document.getElementById('meterFilterDate').addEventListener('change', () => debouncedListenMeterReports(1));

            const debouncedListenDamageReports = debounce(listenDamageReports, 300);
            document.getElementById('damageFilterBlock').addEventListener('change', () => debouncedListenDamageReports(1));
            document.getElementById('damageFilterDate').addEventListener('change', () => debouncedListenDamageReports(1));

            const debouncedLoadEducationContent = debounce(loadEducationContent, 300);
            document.getElementById('educationSearch').addEventListener('input', debouncedLoadEducationContent);
            document.getElementById('educationCategory').addEventListener('change', debouncedLoadEducationContent);

            document.getElementById('meterBlock').addEventListener('change', async () => {
                const actualUsage = await calculateActualUsage(
                    document.getElementById('meterBlock').value,
                    document.getElementById('meterLocation').value,
                    parseFloat(document.getElementById('meterReading').value) || 0,
                    new Date().toLocaleDateString('id-ID')
                );
                document.getElementById('actualUsage').textContent = actualUsage !== null ? `Pemakaian Aktual: ${actualUsage.toFixed(2)} m³` : 'Tidak ada data sebelumnya';
            });

            document.getElementById('meterReading').addEventListener('input', async () => {
                const actualUsage = await calculateActualUsage(
                    document.getElementById('meterBlock').value,
                    document.getElementById('meterLocation').value,
                    parseFloat(document.getElementById('meterReading').value) || 0,
                    new Date().toLocaleDateString('id-ID')
                );
                document.getElementById('actualUsage').textContent = actualUsage !== null ? `Pemakaian Aktual: ${actualUsage.toFixed(2)} m³` : 'Tidak ada data sebelumnya';
            });

            setInterval(updateTime, 1000);
            updateTime();
            populateBlockLocations('meterBlock', 'meterLocation');
            populateBlockLocations('damageBlock', 'damageLocation');
            populateBlockLocations('estimationBlock', 'estimationLocation');
            populateMeterFilterBlock();
            populateDamageFilterBlock();
            populateMeterFilterDate();
            populateDamageFilterDate();
            importEducationData();
        });
    </script>
</body>
</html>