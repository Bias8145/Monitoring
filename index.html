<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Checklist Air</title>
    <!-- Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background 0.3s ease;
        }

        /* Tema Terang */
        body.light-theme {
            background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
            color: #333;
        }

        body.light-theme .container,
        body.light-theme .login-card,
        body.light-theme .modal {
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
        }

        body.light-theme .card {
            background: rgba(245, 245, 245, 0.9);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }

        body.light-theme .header {
            background: linear-gradient(135deg, #ffffff, #e0e0e0);
            color: #333;
        }

        body.light-theme .form-group select,
        body.light-theme .form-group input,
        body.light-theme .form-group textarea,
        body.light-theme .login-card input {
            background: rgba(220, 220, 220, 0.85);
            color: #333;
        }

        body.light-theme .unit {
            background: rgba(76, 175, 80, 0.3);
            color: #333;
        }

        body.light-theme .switch-type {
            background: rgba(220, 220, 220, 0.9);
        }

        body.light-theme .switch-btn {
            color: #333;
        }

        body.light-theme table {
            background: rgba(245, 245, 245, 0.9);
        }

        body.light-theme th {
            background: rgba(230, 230, 230, 0.95);
        }

        body.light-theme .theme-toggle {
            background: rgba(220, 220, 220, 0.85);
            color: #333;
        }

        body.light-theme .nav-bar {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        body.light-theme .nav-item {
            color: #333;
        }

        body.light-theme .nav-item:hover {
            background: rgba(76, 175, 80, 0.1);
        }

        /* Tema Gelap */
        body.dark-theme {
            background: linear-gradient(135deg, #1e1e2f, #2a2a4a);
            color: #e0e0e0;
        }

        body.dark-theme .container,
        body.dark-theme .login-card,
        body.dark-theme .modal {
            background: rgba(30, 30, 46, 0.85);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5);
        }

        body.dark-theme .card {
            background: rgba(40, 40, 60, 0.9);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
        }

        body.dark-theme .header {
            background: linear-gradient(135deg, #2e2e4a, #3a3a5a);
            color: #e0e0e0;
        }

        body.dark-theme .form-group select,
        body.dark-theme .form-group input,
        body.dark-theme .form-group textarea,
        body.dark-theme .login-card input {
            background: rgba(50, 50, 70, 0.85);
            color: #e0e0e0;
        }

        body.dark-theme .unit {
            background: rgba(76, 175, 80, 0.2);
            color: #e0e0e0;
        }

        body.dark-theme .switch-type {
            background: rgba(40, 40, 60, 0.9);
        }

        body.dark-theme .switch-btn {
            color: #e0e0e0;
        }

        body.dark-theme table {
            background: rgba(40, 40, 60, 0.9);
        }

        body.dark-theme th {
            background: rgba(50, 50, 70, 0.95);
        }

        body.dark-theme .theme-toggle {
            background: rgba(50, 50, 70, 0.85);
            color: #e0e0e0;
        }

        body.dark-theme .nav-bar {
            background: rgba(30, 30, 46, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        body.dark-theme .nav-item {
            color: #e0e0e0;
        }

        body.dark-theme .nav-item:hover {
            background: rgba(76, 175, 80, 0.3);
        }

        .container {
            max-width: 600px;
            width: 100%;
            border-radius: 20px;
            backdrop-filter: blur(12px);
            overflow: hidden;
            position: relative;
            z-index: 1;
            padding-bottom: 100px; /* Prevent overlap with nav-bar */
        }

        .card {
            border-radius: 16px;
            padding: 20px;
            margin: 15px;
            transform: perspective(1000px) rotateX(3deg) translateZ(10px);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: perspective(1000px) rotateX(0deg) translateZ(20px);
        }

        .header {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px 20px 0 0;
            position: relative;
            transform: perspective(1000px) translateZ(15px);
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .header .greeting {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .header .subtitle {
            font-size: 14px;
            opacity: 0.7;
        }

        .form-group {
            margin-bottom: 20px;
            position: relative;
            transform: perspective(1000px) translateZ(5px);
        }

        .form-group select,
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            transition: background 0.3s ease, box-shadow 0.3s ease;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-group select:focus,
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.3);
        }

        .input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .unit {
            padding: 12px;
            border-radius: 12px;
            min-width: 50px;
            text-align: center;
            font-size: 14px;
        }

        .section-divider {
            height: 2px;
            background: linear-gradient(90deg, #4CAF50, #81C784);
            margin: 20px 0;
            border-radius: 2px;
            transform: perspective(1000px) translateZ(5px);
        }

        .switch-type {
            display: flex;
            gap: 10px;
            border-radius: 12px;
            padding: 8px;
            margin-bottom: 20px;
            transform: perspective(1000px) translateZ(10px);
        }

        .switch-btn {
            flex: 1;
            padding: 12px;
            text-align: center;
            border: none;
            border-radius: 10px;
            background: none;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .switch-btn.active {
            background: #4CAF50;
            color: white;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
        }

        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            transition: all 0.3s ease;
            transform: perspective(1000px) translateZ(10px);
        }

        .btn:hover {
            transform: perspective(1000px) translateZ(20px);
            box-shadow: 0 8px 20px rgba(76, 175, 80, 0.4);
        }

        .table-container {
            max-height: 300px;
            overflow-y: auto;
            margin: 15px 0;
            border-radius: 12px;
            transform: perspective(1000px) translateZ(5px);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            border-radius: 12px;
            overflow: hidden;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        th {
            position: sticky;
            top: 0;
            font-weight: 600;
        }

        td button {
            padding: 8px 12px;
            border: none;
            border-radius: 10px;
            background: #4CAF50;
            color: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            transform: perspective(1000px) translateZ(5px);
        }

        td button:hover {
            background: #45a049;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
            transform: perspective(1000px) translateZ(10px);
        }

        td button.whatsapp-btn {
            background: #25D366;
        }

        td button.whatsapp-btn:hover {
            background: #20B058;
            box-shadow: 0 4px 12px rgba(37, 211, 102, 0.4);
        }

        td button.edit-btn {
            background: #FFC107;
            color: #333;
        }

        td button.edit-btn:hover {
            background: #FFB300;
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.4);
        }

        td button.edit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .filter-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            transform: perspective(1000px) translateZ(5px);
        }

        .filter-group select {
            flex: 1;
            min-width: 120px;
            padding: 12px;
            border-radius: 12px;
            font-size: 14px;
        }

        .login-container {
            max-width: 400px;
            width: 100%;
            text-align: center;
            position: relative;
            z-index: 1;
        }

        .login-card {
            backdrop-filter: blur(12px);
            padding: 30px;
            border-radius: 20px;
            transform: perspective(1000px) rotateX(5deg) translateZ(20px);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .login-card:hover {
            transform: perspective(1000px) rotateX(0deg) translateZ(30px);
        }

        .login-card h1 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .login-card .subtitle {
            font-size: 16px;
            opacity: 0.7;
            margin-bottom: 20px;
        }

        .login-card input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            transform: perspective(1000px) translateZ(5px);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(244, 67, 54, 0.9);
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: none;
            font-size: 14px;
            transform: perspective(1000px) translateZ(10px);
            z-index: 1000;
        }

        .notification.success {
            background: rgba(76, 175, 80, 0.9);
        }

        .theme-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 1000;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
        }

        .theme-toggle i {
            font-size: 24px;
        }

        .nav-bar {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            max-width: 600px;
            width: 90%;
            display: flex;
            justify-content: space-around;
            padding: 12px 16px;
            border-radius: 16px;
            z-index: 1000;
            transition: all 0.3s ease;
            backdrop-filter: blur(12px);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            padding: 8px 12px;
            font-size: 12px;
            transition: all 0.3s ease;
            border-radius: 12px;
        }

        .nav-item i {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .nav-item span {
            font-size: 11px;
            font-weight: 500;
        }

        .nav-item.active {
            background: #4CAF50;
            color: white;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.4);
        }

        .nav-item:hover {
            background: rgba(76, 175, 80, 0.2);
            color: #4CAF50;
            transform: translateY(-2px);
        }

        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            padding: 20px;
            border-radius: 12px;
            z-index: 1000;
            backdrop-filter: blur(12px);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .modal-header h2 {
            font-size: 20px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: inherit;
        }

        .modal-content {
            font-size: 14px;
            line-height: 1.5;
        }

        .modal-content ul {
            list-style-type: disc;
            margin-left: 20px;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
    </style>
</head>

<body class="dark-theme">
    <!-- Tombol Tema -->
    <div class="theme-toggle" id="themeToggle">
        <i id="themeIcon" class="fas fa-sun"></i>
    </div>

    <!-- Navigation Bar -->
    <nav class="nav-bar">
        <div class="nav-item active" data-page="mainPage">
            <i class="fas fa-list-check"></i>
            <span>Checklist</span>
        </div>
        <div class="nav-item" data-page="meterPage">
            <i class="fas fa-tachometer-alt"></i>
            <span>Meter Lapangan</span>
        </div>
        <div class="nav-item" data-page="damagePage">
            <i class="fas fa-exclamation-triangle"></i>
            <span>Kerusakan</span>
        </div>
    </nav>

    <!-- Halaman Login -->
    <div id="loginPage" class="login-container">
        <div class="login-card">
            <h1>Sistem Checklist Air</h1>
            <div class="subtitle">Login Aman</div>
            <div class="form-group">
                <input type="text" id="nikInput" placeholder="Masukkan NIK (Contoh: CA00006)" required>
            </div>
            <button class="btn" id="loginButton">Masuk</button>
        </div>
    </div>

    <!-- Halaman Checklist -->
    <div id="mainPage" class="container" style="display: none;">
        <div class="header">
            <div class="greeting" id="greeting">Selamat Pagi, User!</div>
            <h1>Checklist Sistem Air</h1>
            <div class="subtitle">Monitoring & Pemeliharaan</div>
        </div>

        <div class="card">
            <div class="shift-info">Shift: <span id="shiftInfo"></span> | Waktu: <span id="currentTime">00:00:00</span></div>
        </div>

        <div class="card">
            <div class="switch-type">
                <button class="switch-btn active" id="switchMasuk">CHECKLIST MASUK</button>
                <button class="switch-btn" id="switchPulang">CHECKLIST PULANG</button>
                <button class="switch-btn" id="switchCustom">CUSTOM CHECKLIST</button>
            </div>
        </div>

        <div class="card" id="checklistFormContainer">
            <form id="checklistForm">
                <div class="form-group">
                    <select id="bakRO" required>
                        <option value="">Pilih Kondisi Bak Distribusi Air RO...</option>
                        <option value="Memadai">Memadai</option>
                        <option value="Tidak Memadai">Tidak Memadai</option>
                    </select>
                </div>
                <div class="form-group">
                    <div class="input-group">
                        <input type="number" id="tinggiRO" placeholder="Ketinggian Bak RO (cm)" required>
                        <div class="unit">cm</div>
                    </div>
                </div>
                <div class="section-divider"></div>
                <div class="form-group">
                    <select id="bakWWTP" required>
                        <option value="">Pilih Kondisi Bak Input RO dari WWTP...</option>
                        <option value="Memadai">Memadai</option>
                        <option value="Tidak Memadai">Tidak Memadai</option>
                    </select>
                </div>
                <div class="form-group">
                    <div class="input-group">
                        <input type="number" id="tinggiWWTP" placeholder="Ketinggian Bak WWTP (cm)" required>
                        <div class="unit">cm</div>
                    </div>
                </div>
                <div class="section-divider"></div>
                <div class="form-group">
                    <select id="pompa" required>
                        <option value="">Pilih Kondisi Pompa Transfer WWTP RO...</option>
                        <option value="ON">ON</option>
                        <option value="OFF">OFF</option>
                    </select>
                </div>
                <div class="section-divider"></div>
                <div class="form-group">
                    <div class="input-group">
                        <input type="number" id="tinggiPDAM" placeholder="Ketinggian Bak Input Air PDAM (cm)" required>
                        <div class="unit">cm</div>
                    </div>
                </div>
                <div class="form-group">
                    <select id="statusPDAM" required>
                        <option value="">Pilih Status Bak Input PDAM...</option>
                        <option value="Memadai">Memadai</option>
                        <option value="Tidak Memadai">Tidak Memadai</option>
                    </select>
                </div>
                <div class="form-group">
                    <select id="hydrantStatus" required>
                        <option value="">Pilih Status Hydrant...</option>
                        <option value="ON">ON</option>
                        <option value="OFF">OFF</option>
                    </select>
                </div>
                <div class="section-divider"></div>
                <div class="form-group">
                    <select id="supplyPDAM" required>
                        <option value="">Pilih Status Supply Air PDAM...</option>
                        <option value="Menyala">Menyala</option>
                        <option value="Mati">Mati</option>
                    </select>
                </div>
                <div class="form-group">
                    <input type="number" id="meterIndukPDAM" placeholder="Angka Meter Induk PDAM" required>
                </div>
                <div class="form-group">
                    <input type="number" id="meterIndukWTP" placeholder="Angka Meter Induk WTP" required>
                </div>
                <div class="form-group">
                    <div class="input-group">
                        <input type="number" id="flowPDAM" placeholder="Flow Rate Input (m³)" required>
                        <div class="unit">m³</div>
                    </div>
                </div>
                <div class="form-group">
                    <input type="text" id="catatan" placeholder="Catatan Tambahan (Opsional)">
                </div>
                <button type="submit" class="btn" id="saveChecklistButton">Simpan Checklist</button>
            </form>
        </div>

        <div class="card" id="reportSection">
            <h2 style="margin-bottom: 15px; font-size: 20px; font-weight: 600;">Laporan Checklist</h2>
            <div class="filter-group">
                <select id="filterDate">
                    <option value="">Semua Tanggal</option>
                </select>
                <select id="filterShift">
                    <option value="">Semua Shift</option>
                    <option value="masuk">Masuk</option>
                    <option value="pulang">Pulang</option>
                    <option value="custom">Custom</option>
                </select>
                <select id="filterNIK">
                    <option value="">Semua Pengguna</option>
                </select>
            </div>
            <div class="table-container">
                <table id="reportTable">
                    <thead>
                        <tr>
                            <th>Tanggal</th>
                            <th>Waktu</th>
                            <th>Shift</th>
                            <th>Penginput</th>
                            <th>Catatan</th>
                            <th>Detail</th>
                            <th>Share</th>
                            <th>Edit</th>
                        </tr>
                    </thead>
                    <tbody id="reportBody"></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Halaman Check Meter Lapangan -->
    <div id="meterPage" class="container" style="display: none;">
        <div class="header">
            <div class="greeting" id="meterGreeting">Selamat Pagi, User!</div>
            <h1>Check Meter Lapangan</h1>
            <div class="subtitle">Monitoring Meter Air</div>
        </div>
        <div class="card">
            <form id="meterForm">
                <div class="form-group">
                    <select id="meterBlock" required>
                        <option value="">Pilih Blok...</option>
                        <option value="Induk">Induk</option>
                        <option value="Blok A">Blok A</option>
                        <option value="Blok B">Blok B</option>
                        <option value="Blok C">Blok C</option>
                        <option value="Blok D">Blok D</option>
                        <option value="Blok E">Blok E</option>
                        <option value="Blok F">Blok F</option>
                        <option value="Blok G">Blok G</option>
                        <option value="Blok H">Blok H</option>
                        <option value="Blok P">Blok P</option>
                        <option value="Blok J">Blok J</option>
                    </select>
                </div>
                <div class="form-group">
                    <select id="meterLocation" required>
                        <option value="">Pilih Lokasi...</option>
                    </select>
                </div>
                <div class="form-group">
                    <div class="input-group">
                        <input type="number" id="meterReading" placeholder="Angka Meter" required>
                        <div class="unit">m³</div>
                    </div>
                </div>
                <div class="form-group">
                    <div id="actualUsage" style="font-size: 14px; margin-top: 10px;"></div>
                </div>
                <div class="form-group">
                    <input type="text" id="meterNotes" placeholder="Catatan (Opsional)">
                </div>
                <button type="submit" class="btn" id="saveMeterButton">Simpan Meter</button>
            </form>
        </div>
        <div class="card">
            <h2 style="margin-bottom: 15px; font-size: 20px; font-weight: 600;">Laporan Meter</h2>
            <div class="filter-group">
                <select id="meterFilterBlock">
                    <option value="">Semua Blok</option>
                </select>
                <select id="meterFilterDate">
                    <option value="">Semua Tanggal</option>
                </select>
            </div>
            <div class="table-container">
                <table id="meterTable">
                    <thead>
                        <tr>
                            <th>Tanggal</th>
                            <th>Waktu</th>
                            <th>Blok</th>
                            <th>Lokasi</th>
                            <th>Angka Meter</th>
                            <th>Aktual</th>
                            <th>Catatan</th>
                            <th>Share</th>
                        </tr>
                    </thead>
                    <tbody id="meterReportBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Halaman Laporan Kerusakan -->
    <div id="damagePage" class="container" style="display: none;">
        <div class="header">
            <div class="greeting" id="damageGreeting">Selamat Pagi, User!</div>
            <h1>Laporan Kerusakan</h1>
            <div class="subtitle">Pelaporan Kerusakan</div>
        </div>
        <div class="card">
            <form id="damageForm">
                <div class="form-group">
                    <select id="damageType" required>
                        <option value="">Pilih Jenis Kerusakan...</option>
                        <option value="Kebocoran">Kebocoran</option>
                        <option value="Kerusakan Pipa">Kerusakan Pipa</option>
                        <option value="Pompa Mati">Pompa Mati</option>
                        <option value="Lainnya">Lainnya</option>
                    </select>
                </div>
                <div class="form-group">
                    <select id="damageBlock" required>
                        <option value="">Pilih Blok...</option>
                        <option value="Induk">Induk</option>
                        <option value="Blok A">Blok A</option>
                        <option value="Blok B">Blok B</option>
                        <option value="Blok C">Blok C</option>
                        <option value="Blok D">Blok D</option>
                        <option value="Blok E">Blok E</option>
                        <option value="Blok F">Blok F</option>
                        <option value="Blok G">Blok G</option>
                        <option value="Blok H">Blok H</option>
                        <option value="Blok P">Blok P</option>
                        <option value="Blok J">Blok J</option>
                    </select>
                </div>
                <div class="form-group">
                    <select id="damageLocation" required>
                        <option value="">Pilih Lokasi...</option>
                    </select>
                </div>
                <div class="form-group">
                    <input type="text" id="damageSpecific" placeholder="Spesifik Lokasi" required>
                </div>
                <div class="form-group">
                    <textarea id="damageNotes" placeholder="Catatan"></textarea>
                </div>
                <button type="submit" class="btn" id="saveDamageButton">Simpan Laporan</button>
            </form>
        </div>
        <div class="card">
            <h2 style="margin-bottom: 15px; font-size: 20px; font-weight: 600;">Laporan Kerusakan</h2>
            <div class="filter-group">
                <select id="damageFilterBlock">
                    <option value="">Semua Blok</option>
                </select>
                <select id="damageFilterDate">
                    <option value="">Semua Tanggal</option>
                </select>
            </div>
            <div class="table-container">
                <table id="damageTable">
                    <thead>
                        <tr>
                            <th>Tanggal</th>
                            <th>Jenis Kerusakan</th>
                            <th>Blok</th>
                            <th>Lokasi</th>
                            <th>Spesifik</th>
                            <th>Catatan</th>
                            <th>Share</th>
                        </tr>
                    </thead>
                    <tbody id="damageReportBody"></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Modal untuk Detail Laporan -->
    <div id="modalOverlay" class="modal-overlay"></div>
    <div id="detailModal" class="modal">
        <div class="modal-header">
            <h2>Detail Checklist</h2>
            <button class="modal-close" id="modalClose">&times;</button>
        </div>
        <div class="modal-content" id="modalContent"></div>
    </div>

    <div id="notification" class="notification"></div>

    <script type="module">
    // Import Firebase SDK (tanpa Firebase Storage)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, onSnapshot, query, orderBy, serverTimestamp, where, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyBPmuyBT8tTr5V0yZJNbjHHLz_-iY2djpo",
        authDomain: "water-checklist.firebaseapp.com",
        projectId: "water-checklist",
        storageBucket: "water-checklist.firebasestorage.app",
        messagingSenderId: "84158811467",
        appId: "1:84158811467:web:717bd038c3da5362ad2cce"
    };

    // Initialize Firebase
    let db;
    try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        console.log('Firebase berhasil diinisialisasi');
    } catch (error) {
        console.error('Gagal menginisialisasi Firebase:', error);
        showNotification('Gagal menginisialisasi aplikasi. Silakan coba lagi nanti.');
    }

    // Daftar pengguna
    const users = [
        { nik: 'CA00006', name: 'Muhammad Fahruroji' },
        { nik: 'CA00159', name: 'Andri Rahmatulloh' },
        { nik: 'CA00193', name: 'IIP M Ilyas' },
        { nik: 'CA00198', name: 'Shashi Prasetyo' },
        { nik: 'CA00210', name: 'Ridwan Fauzi' },
        { nik: 'CA00383', name: 'Bias Fajar Khaliq' },
        { nik: 'CA00491', name: 'Torik Hidayat' },
        { nik: 'CA00508', name: 'Amanda Lutfi' }
    ];

    // Variabel global
    let currentType = 'masuk';
    let currentNIK = '';
    let currentUserName = '';

    // Definisi shift
    const shifts = [
        { name: '1 Satu', start: 7, end: 15, startInput: '07:00', endInput: '07:30', startOutput: '14:30', endOutput: '15:00' },
        { name: '2 Dua', start: 15, end: 23, startInput: '15:00', endInput: '15:30', startOutput: '22:30', endOutput: '23:00' },
        { name: '3 Tiga', start: 23, end: 7, startInput: '23:00', endInput: '23:30', startOutput: '06:30', endOutput: '07:00' }
    ];

    // Mapping blok dan lokasi
    const blockLocations = {
        'Induk': ['Aquaria', 'Hydran', 'Induk Blok A B C', 'Induk P+D', 'Damkar', 'Blok H', 'Blok E, F, G', 'PDAM', 'PDAM II', 'Hydrant II'],
        'Blok C': ['Toilet C11', 'Toilet C8', 'Toilet C15', 'Toilet C12', 'Toilet C17', 'Toilet C20', 'Manual 1', 'Manual 2', 'Manual 3', 'Manual 4', 'Manual 5'],
        'Blok B': ['B1 Stockfit', 'B1.2 Mesin', 'B1.3 Mesin', 'B1.4 Mesin', 'B3 Cooling Tower', 'B3.2 Mesin', 'B3.3 Mesin', 'B6.1 Toilet', 'B6.2 Toilet', 'B7.1 Toilet', 'B7.2 Toilet'],
        'Blok D': ['D1 Kantin TKA/Dapur', 'D2.1 Mess Bungalow', 'D2.2 Mess Bungalow', 'D2.3 Mess Bungalow', 'D2.6 Mess Bungalow', 'D2.7 Mess Bungalow', 'D2.8 Mess Bungalow', 'D13 Mess Bungalow', 'D3.1 Mess Bungalow', 'D3.2 Mess Bungalow', 'D4.2 Mess Bungalow', 'D5 Mess Bungalow', 'D5 Bungalow'],
        'Blok P': ['P1.1 Toilet', 'P1.2 Toilet', 'Galon', 'Send', 'Carbon', 'Sumur Bor', 'P2 Aquaria', 'P4 WWTP', 'P7 Toilet', 'P8 Office Pusat', 'P10 Kantin', 'P11.1 Toilet', 'P11.2 Kantin Dapur', 'P16 Masjid', 'P21 Damkar', 'P9', 'P17 Masjid'],
        'Blok J': ['J1 Mess Bungalow', 'J2 Mess Bungalow'],
        'Blok A': ['A10 Toilet', 'A17 Toilet', 'A14 Toilet', 'A22 Toilet', 'A19 Toilet', 'A2 Office II', 'A1 Office I', 'A5.2 Sablon', 'A5.1', 'A5 Lab', 'A23 Cooling Tower'],
        'Blok F': ['F1 Lab', 'F3.1 Toilet', 'F3.2 Toilet', 'F3.3 Toilet', 'F3.4 Toilet', 'G8.1 Toilet', 'G8.2 Toilet'],
        'Blok G': ['G12 Cooling Tower', 'G14.1 Mesin', 'G14.2 Cooling Tower', 'G15.1 Toilet', 'G15.2 Toilet'],
        'Blok H': ['H2 Masjid', 'H4 Kantin', 'H5.1 Toilet', 'H5.2 Dapur', 'H5.3 Toilet'],
        'Blok E': ['E21 Office', 'E22 Office', 'E7.1 Toilet', 'E7.2 Toilet', 'E8.1 Toilet', 'E8.2 Toilet', 'E9.1 Toilet', 'E9.2 Toilet', 'E10.3 Toilet', 'E10.4 Toilet']
    };

    // Fungsi untuk menampilkan notifikasi
    function showNotification(message, isSuccess = false) {
        const notification = document.getElementById('notification');
        if (notification) {
            notification.textContent = message;
            notification.className = `notification ${isSuccess ? 'success' : ''}`;
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
                notification.className = 'notification';
            }, 5000);
        } else {
            console.error('Elemen notification tidak ditemukan');
        }
    }

    // Fungsi untuk mengganti tema
    function toggleTheme() {
        const body = document.body;
        const themeIcon = document.getElementById('themeIcon');
        if (body.classList.contains('dark-theme')) {
            body.classList.remove('dark-theme');
            body.classList.add('light-theme');
            themeIcon.classList.remove('fa-sun');
            themeIcon.classList.add('fa-moon');
            localStorage.setItem('theme', 'light');
        } else {
            body.classList.remove('light-theme');
            body.classList.add('dark-theme');
            themeIcon.classList.remove('fa-moon');
            themeIcon.classList.add('fa-sun');
            localStorage.setItem('theme', 'dark');
        }
    }

    // Fungsi untuk mengganti halaman
    function switchPage(pageId) {
        document.querySelectorAll('#mainPage, #meterPage, #damagePage').forEach(page => {
            page.style.display = 'none';
        });
        document.getElementById(pageId).style.display = 'block';
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.toggle('active', item.dataset.page === pageId);
        });
    }

    // Fungsi untuk login
    function login() {
        const nikInput = document.getElementById('nikInput');
        const nikValue = nikInput.value.trim().toUpperCase();
        const user = users.find(u => u.nik === nikValue);
        if (user) {
            currentNIK = nikValue;
            currentUserName = user.name;
            document.getElementById('loginPage').style.display = 'none';
            switchPage('mainPage');
            showNotification(`Selamat datang, ${currentUserName}!`, true);
            updateShiftInfo();
            updateGreeting();
            populateFilters();
            listenReports();
            ['meterGreeting', 'damageGreeting'].forEach(id => {
                document.getElementById(id).textContent = document.getElementById('greeting').textContent;
            });
        } else {
            showNotification('NIK tidak valid! Silakan masukkan NIK yang terdaftar.');
        }
    }

    // Fungsi untuk memperbarui salam
    function updateGreeting() {
        const now = new Date();
        const hour = now.getHours();
        let greetingText = '';
        if ((hour >= 19 && hour <= 23) || (hour >= 0 && hour < 5)) {
            greetingText = `Selamat Malam, ${currentUserName}!`;
        } else if (hour >= 5 && hour < 8) {
            greetingText = `Selamat Pagi, ${currentUserName}!`;
        } else if (hour >= 8 && hour < 17) {
            greetingText = `Selamat Siang, ${currentUserName}!`;
        } else {
            greetingText = `Selamat Sore, ${currentUserName}!`;
        }
        document.getElementById('greeting').textContent = greetingText;
    }

    // Fungsi untuk memperbarui informasi shift
    function updateShiftInfo() {
        const now = new Date();
        const hour = now.getHours();
        let shiftInfo = 'Di luar jam shift';
        shifts.forEach(shift => {
            if (hour >= shift.start || (shift.start > shift.end && hour < shift.end)) {
                shiftInfo = `${shift.name} (${shift.startInput}-${shift.endOutput})`;
            }
        });
        document.getElementById('shiftInfo').textContent = shiftInfo;
    }

    // Fungsi untuk memperbarui waktu
    function updateTime() {
        const now = new Date();
        document.getElementById('currentTime').textContent = now.toLocaleTimeString('id-ID');
        updateShiftInfo();
        updateGreeting();
    }

    // Fungsi untuk mengganti tipe checklist
    function switchType(type) {
        currentType = type;
        document.querySelectorAll('.switch-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`switch${type.charAt(0).toUpperCase() + type.slice(1)}`).classList.add('active');
        const saveButton = document.getElementById('saveChecklistButton');
        saveButton.textContent = 'Simpan Checklist';
        delete saveButton.dataset.editId;
        document.getElementById('checklistForm').reset();
    }

    // Fungsi untuk menampilkan form edit checklist
    function showEditForm(checklist) {
        if (checklist.nik !== currentNIK) {
            showNotification('Anda tidak memiliki izin untuk mengedit laporan ini.');
            return;
        }
        currentType = checklist.shift || 'custom';
        document.querySelectorAll('.switch-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`switch${currentType.charAt(0).toUpperCase() + currentType.slice(1)}`).classList.add('active');
        document.getElementById('bakRO').value = checklist.bakRO || '';
        document.getElementById('tinggiRO').value = checklist.tinggiRO || '';
        document.getElementById('bakWWTP').value = checklist.bakWWTP || '';
        document.getElementById('tinggiWWTP').value = checklist.tinggiWWTP || '';
        document.getElementById('pompa').value = checklist.pompa || '';
        document.getElementById('tinggiPDAM').value = checklist.tinggiPDAM || '';
        document.getElementById('statusPDAM').value = checklist.statusPDAM || '';
        document.getElementById('hydrantStatus').value = checklist.hydrantStatus || '';
        document.getElementById('supplyPDAM').value = checklist.supplyPDAM || '';
        document.getElementById('meterIndukPDAM').value = checklist.meterIndukPDAM || '';
        document.getElementById('meterIndukWTP').value = checklist.meterIndukWTP || '';
        document.getElementById('flowPDAM').value = checklist.flowPDAM || '';
        document.getElementById('catatan').value = checklist.catatan || '';
        const saveButton = document.getElementById('saveChecklistButton');
        saveButton.textContent = 'Update Checklist';
        saveButton.dataset.editId = checklist.id;
        document.getElementById('checklistFormContainer').scrollIntoView({ behavior: 'smooth' });
    }

    // Fungsi untuk menyimpan checklist
    async function saveChecklist(event) {
        event.preventDefault();
        const now = new Date();
        const hour = now.getHours();
        const minute = now.getMinutes();
        const dateStr = now.toLocaleDateString('id-ID');
        let currentShift = null;
        if (currentType !== 'custom') {
            shifts.forEach(shift => {
                if (hour >= shift.start || (shift.start > shift.end && hour < shift.end)) {
                    currentShift = shift;
                }
            });
        }

        if (currentType !== 'custom' && !currentShift) {
            showNotification('Checklist masuk/pulang hanya dapat dilakukan selama jam shift!');
            return;
        }

        if (currentType !== 'custom') {
            const [startInputHour, startInputMinute] = currentShift.startInput.split(':').map(Number);
            const [endInputHour, endInputMinute] = currentShift.endInput.split(':').map(Number);
            const [startOutputHour, startOutputMinute] = currentShift.startOutput.split(':').map(Number);
            const [endOutputHour, endOutputMinute] = currentShift.endOutput.split(':').map(Number);

            const isValidMasuk = currentType === 'masuk' &&
                ((hour === startInputHour && minute >= startInputMinute && (hour < endInputHour || (hour === endInputHour && minute <= endInputMinute))) ||
                 (startInputHour > endInputHour && (hour >= startInputHour || hour < endInputHour || (hour === endInputHour && minute <= endInputMinute))));

            const isValidPulang = currentType === 'pulang' &&
                ((hour === startOutputHour && minute >= startOutputMinute && (hour < endOutputHour || (hour === endOutputHour && minute <= endOutputMinute))) ||
                 (startOutputHour > endOutputHour && (hour >= startOutputHour || hour < endOutputHour || (hour === endOutputHour && minute <= endOutputMinute))));

            if (!isValidMasuk && !isValidPulang) {
                showNotification(`Checklist ${currentType} untuk ${currentShift.name} hanya dapat dilakukan pada ${currentType === 'masuk' ? `${currentShift.startInput}-${currentShift.endInput}` : `${currentShift.startOutput}-${currentShift.endOutput}`}. Silakan coba lagi pada waktu yang sesuai.`);
                return;
            }
        }

        const user = users.find(u => u.nik === currentNIK);
        const data = {
            nik: currentNIK,
            name: user ? user.name : 'Unknown',
            date: dateStr,
            time: now.toLocaleTimeString('id-ID'),
            shift: currentType,
            shiftName: currentType === 'custom' ? 'Custom' : currentShift ? currentShift.name : 'Unknown',
            bakRO: document.getElementById('bakRO').value,
            tinggiRO: parseFloat(document.getElementById('tinggiRO').value) || 0,
            bakWWTP: document.getElementById('bakWWTP').value,
            tinggiWWTP: parseFloat(document.getElementById('tinggiWWTP').value) || 0,
            pompa: document.getElementById('pompa').value,
            tinggiPDAM: parseFloat(document.getElementById('tinggiPDAM').value) || 0,
            statusPDAM: document.getElementById('statusPDAM').value,
            hydrantStatus: document.getElementById('hydrantStatus').value,
            supplyPDAM: document.getElementById('supplyPDAM').value,
            meterIndukPDAM: parseFloat(document.getElementById('meterIndukPDAM').value) || 0,
            meterIndukWTP: parseFloat(document.getElementById('meterIndukWTP').value) || 0,
            flowPDAM: parseFloat(document.getElementById('flowPDAM').value) || 0,
            catatan: document.getElementById('catatan').value || '',
            createdAt: serverTimestamp()
        };

        const required = ['bakRO', 'tinggiRO', 'bakWWTP', 'tinggiWWTP', 'pompa', 'tinggiPDAM', 'statusPDAM', 'hydrantStatus', 'supplyPDAM', 'meterIndukPDAM', 'meterIndukWTP', 'flowPDAM'];
        const missing = required.filter(field => !data[field] && data[field] !== 0);

        if (missing.length > 0) {
            showNotification('Mohon lengkapi semua field yang wajib diisi!');
            return;
        }

        try {
            const saveButton = document.getElementById('saveChecklistButton');
            if (saveButton.dataset.editId) {
                await updateDoc(doc(db, 'checklists', saveButton.dataset.editId), data);
                showNotification('Checklist berhasil diperbarui!', true);
                saveButton.textContent = 'Simpan Checklist';
                delete saveButton.dataset.editId;
            } else {
                await addDoc(collection(db, 'checklists'), data);
                showNotification('Checklist berhasil disimpan!', true);
            }
            document.getElementById('checklistForm').reset();
        } catch (error) {
            console.error('Gagal menyimpan checklist:', error);
            showNotification(`Gagal menyimpan checklist: ${error.message}`);
        }
    }

    // Fungsi untuk memuat laporan checklist
    function listenReports() {
        const filterDate = document.getElementById('filterDate');
        const filterShift = document.getElementById('filterShift');
        const filterNIK = document.getElementById('filterNIK');
        const reportBody = document.getElementById('reportBody');
        
        let q = query(collection(db, 'checklists'), orderBy('createdAt', 'desc'));

        if (filterDate.value) q = query(q, where('date', '==', filterDate.value));
        if (filterShift.value) q = query(q, where('shift', '==', filterShift.value));
        if (filterNIK.value) q = query(q, where('nik', '==', filterNIK.value));

        onSnapshot(q, (snapshot) => {
            reportBody.innerHTML = '';
            const checklists = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            if (checklists.length === 0) {
                reportBody.innerHTML = '<tr><td colspan="8">Tidak ada data checklist.</td></tr>';
            } else {
                checklists.forEach(c => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${c.date || '-'}</td>
                        <td>${c.time || '-'}</td>
                        <td>${c.shift ? c.shift.toUpperCase() : '-'} ${c.shiftName !== 'Custom' ? '(' + (c.shiftName || '-') + ')' : ''}</td>
                        <td>${c.nik || '-'} - ${c.name || '-'}</td>
                        <td>${c.catatan || '-'}</td>
                        <td><button class="detail-btn" data-detail='${JSON.stringify(c).replace(/'/g, "&apos;")}'>Lihat</button></td>
                        <td><button class="whatsapp-btn" data-detail='${JSON.stringify(c).replace(/'/g, "&apos;")}'><i class="fab fa-whatsapp"></i> Share</button></td>
                        <td><button class="edit-btn" data-detail='${JSON.stringify(c).replace(/'/g, "&apos;")}' ${c.nik !== currentNIK ? 'disabled' : ''}>Edit</button></td>
                    `;
                    reportBody.appendChild(row);
                });
            }
        }, (error) => {
            console.error('Error fetching checklists:', error);
            showNotification('Gagal memuat laporan checklist.');
        });
    }

    // Fungsi untuk mengisi filter checklist
    async function populateFilters() {
        const filterDate = document.getElementById('filterDate');
        const filterNIK = document.getElementById('filterNIK');
        const snapshot = await getDocs(query(collection(db, 'checklists'), orderBy('date', 'desc')));
        const checklists = snapshot.docs.map(doc => doc.data());
        const dates = [...new Set(checklists.map(c => c.date))].sort((a, b) => new Date(b) - new Date(a));
        const nikOptions = users.map(u => `<option value="${u.nik}">${u.nik} - ${u.name}</option>`);
        filterDate.innerHTML = '<option value="">Semua Tanggal</option>' + dates.map(d => `<option value="${d}">${d}</option>`).join('');
        filterNIK.innerHTML = '<option value="">Semua Pengguna</option>' + nikOptions.join('');
    }

    // Fungsi untuk menampilkan detail checklist
    function showDetail(data) {
        const modal = document.getElementById('detailModal');
        const modalContent = document.getElementById('modalContent');
        const modalOverlay = document.getElementById('modalOverlay');
        modalContent.innerHTML = `
            <ul>
                <li><strong>Tanggal:</strong> ${data.date || '-'}</li>
                <li><strong>Waktu:</strong> ${data.time || '-'}</li>
                <li><strong>Shift:</strong> ${data.shift ? data.shift.toUpperCase() : '-'} ${data.shiftName !== 'Custom' ? '(' + (data.shiftName || '-') + ')' : ''}</li>
                <li><strong>Penginput:</strong> ${data.nik || '-'} - ${data.name || '-'}</li>
                <li><strong>1. Bak Distribusi RO</strong>
                    <ul>
                        <li>Status: ${data.bakRO || '-'}</li>
                        <li>Ketinggian: ${data.tinggiRO || 0} cm</li>
                    </ul>
                </li>
                <li><strong>2. Bak Input WWTP</strong>
                    <ul>
                        <li>Status: ${data.bakWWTP || '-'}</li>
                        <li>Ketinggian: ${data.tinggiWWTP || 0} cm</li>
                    </ul>
                </li>
                <li><strong>3. Pompa Transfer</strong>
                    <ul>
                        <li>Status: ${data.pompa || '-'}</li>
                    </ul>
                </li>
                <li><strong>4. Bak Input PDAM</strong>
                    <ul>
                        <li>Ketinggian: ${data.tinggiPDAM || 0} cm</li>
                        <li>Status: ${data.statusPDAM || '-'}</li>
                        <li>Hydrant Status: ${data.hydrantStatus || '-'}</li>
                    </ul>
                </li>
                <li><strong>5. Supply Air PDAM</strong>
                    <ul>
                        <li>Status: ${data.supplyPDAM || '-'}</li>
                        <li>Meter Induk PDAM: ${data.meterIndukPDAM || 0}</li>
                        <li>Meter Induk WTP: ${data.meterIndukWTP || 0}</li>
                        <li>Flow Rate: ${data.flowPDAM || 0} m³</li>
                    </ul>
                </li>
                <li><strong>Catatan:</strong> ${data.catatan || '-'}</li>
            </ul>
        `;
        modal.style.display = 'block';
        modalOverlay.style.display = 'block';
    }

    // Fungsi untuk menutup modal
    function closeModal() {
        document.getElementById('detailModal').style.display = 'none';
        document.getElementById('modalOverlay').style.display = 'none';
    }

    // Fungsi untuk share checklist ke WhatsApp
    function shareChecklist(data) {
        const message = encodeURIComponent(`
Checklist Sistem Air
• Tanggal: ${data.date || '-'}
• Waktu: ${data.time || '-'}
• Shift: ${data.shift ? data.shift.toUpperCase() : '-'} ${data.shiftName !== 'Custom' ? '(' + (data.shiftName || '-') + ')' : ''}
• Penginput: ${data.nik || '-'} - ${data.name || '-'}

1. Bak Distribusi RO
   • Status: ${data.bakRO || '-'}
   • Ketinggian: ${data.tinggiRO || 0} cm

2. Bak Input WWTP
   • Status: ${data.bakWWTP || '-'}
   • Ketinggian: ${data.tinggiWWTP || 0} cm

3. Pompa Transfer
   • Status: ${data.pompa || '-'}

4. Bak Input PDAM
   • Ketinggian: ${data.tinggiPDAM || 0} cm
   • Status: ${data.statusPDAM || '-'}
   • Hydrant Status: ${data.hydrantStatus || '-'}

5. Supply Air PDAM
   • Status: ${data.supplyPDAM || '-'}
   • Meter Induk PDAM: ${data.meterIndukPDAM || 0}
   • Meter Induk WTP: ${data.meterIndukWTP || 0}
   • Flow Rate: ${data.flowPDAM || 0} m³

• Catatan: ${data.catatan || '-'}`);
        window.open(`https://wa.me/?text=${message}`, '_blank');
    }

    // Fungsi untuk mengisi filter blok meter
    function populateMeterBlockFilter() {
        const meterFilterBlock = document.getElementById('meterFilterBlock');
        meterFilterBlock.innerHTML = '<option value="">Semua Blok</option>' +
            Object.keys(blockLocations).map(block => `<option value="${block}">${block}</option>`).join('');
    }

    // Fungsi untuk mengisi lokasi meter berdasarkan blok
    function populateMeterLocations() {
        const blockSelect = document.getElementById('meterBlock');
        const locationSelect = document.getElementById('meterLocation');
        const selectedBlock = blockSelect.value;
        locationSelect.innerHTML = '<option value="">Pilih Lokasi...</option>';
        if (selectedBlock && blockLocations[selectedBlock]) {
            locationSelect.innerHTML += blockLocations[selectedBlock].map(loc => `<option value="${loc}">${loc}</option>`).join('');
        }
    }

    // Fungsi untuk mendapatkan angka meter sebelumnya
    async function getPreviousMeterReading(block, location, currentDate) {
        try {
            const previousDay = new Date(currentDate);
            previousDay.setDate(currentDate.getDate() - 1);
            const previousDateStr = previousDay.toLocaleDateString('id-ID');
            console.log(`Mencari data sebelumnya: Blok=${block}, Lokasi=${location}, Tanggal=${previousDateStr}`);
            const q = query(
                collection(db, 'meters'),
                where('block', '==', block),
                where('location', '==', location),
                where('date', '==', previousDateStr),
                orderBy('createdAt', 'desc')
            );
            const snapshot = await getDocs(q);
            if (!snapshot.empty) {
                const data = snapshot.docs[0].data();
                console.log('Data sebelumnya ditemukan:', data);
                return data.meterReading;
            } else {
                console.log('Tidak ada data sebelumnya ditemukan');
                return null;
            }
        } catch (error) {
            console.error('Gagal mengambil data meter sebelumnya:', error);
            return null;
        }
    }

    // Fungsi untuk menampilkan penggunaan aktual
    async function updateActualUsage() {
        const block = document.getElementById('meterBlock').value;
        const location = document.getElementById('meterLocation').value;
        const meterReadingInput = document.getElementById('meterReading');
        const actualUsageDisplay = document.getElementById('actualUsage');
        if (!block || !location || !meterReadingInput.value) {
            actualUsageDisplay.textContent = '';
            return;
        }
        const currentReading = parseFloat(meterReadingInput.value) || 0;
        const previousReading = await getPreviousMeterReading(block, location, new Date());
        if (previousReading !== null) {
            const actualUsage = currentReading - previousReading;
            actualUsageDisplay.textContent = `Penggunaan Aktual: ${actualUsage.toFixed(2)} m³`;
            actualUsageDisplay.style.color = actualUsage < 0 ? '#F44336' : '#4CAF50';
        } else {
            actualUsageDisplay.textContent = 'Tidak ada data sebelumnya';
        }
    }

    // Fungsi untuk menyimpan data meter
    async function saveMeter(event) {
        event.preventDefault();
        const saveButton = document.getElementById('saveMeterButton');
        saveButton.disabled = true;
        saveButton.textContent = 'Menyimpan...';

        const now = new Date();
        const block = document.getElementById('meterBlock').value;
        const location = document.getElementById('meterLocation').value;
        const currentReading = parseFloat(document.getElementById('meterReading').value) || 0;
        const notes = document.getElementById('meterNotes').value || '';

        console.log('Menyimpan data meter:', { block, location, currentReading, notes });

        // Validasi input
        if (!block || !location || isNaN(currentReading)) {
            showNotification('Mohon lengkapi semua field yang wajib diisi!');
            saveButton.disabled = false;
            saveButton.textContent = 'Simpan Meter';
            return;
        }

        try {
            const previousReading = await getPreviousMeterReading(block, location, now);
            const actualUsage = previousReading !== null ? currentReading - previousReading : null;

            if (actualUsage !== null && actualUsage < 0) {
                showNotification('Angka meter tidak valid: lebih kecil dari pembacaan sebelumnya!');
                saveButton.disabled = false;
                saveButton.textContent = 'Simpan Meter';
                return;
            }

            const data = {
                nik: currentNIK,
                name: currentUserName,
                date: now.toLocaleDateString('id-ID'),
                time: now.toLocaleTimeString('id-ID'),
                block,
                location,
                meterReading: currentReading,
                actualUsage: actualUsage !== null ? actualUsage : 0,
                notes,
                createdAt: serverTimestamp()
            };

            console.log('Data yang akan disimpan:', data);
            await addDoc(collection(db, 'meters'), data);
            showNotification('Data meter berhasil disimpan!', true);
            document.getElementById('meterForm').reset();
            document.getElementById('meterLocation').innerHTML = '<option value="">Pilih Lokasi...</option>';
            document.getElementById('actualUsage').textContent = '';
        } catch (error) {
            console.error('Gagal menyimpan data meter:', error);
            showNotification(`Gagal menyimpan data meter: ${error.message}`);
        } finally {
            saveButton.disabled = false;
            saveButton.textContent = 'Simpan Meter';
        }
    }
    
    // Fungsi untuk memuat laporan meter
    function listenMeterReports() {
        const filterBlock = document.getElementById('meterFilterBlock');
        const filterDate = document.getElementById('meterFilterDate');
        const reportBody = document.getElementById('meterReportBody');

        let q = query(collection(db, 'meters'), orderBy('createdAt', 'desc'));

        if (filterBlock.value) {
            console.log('Menerapkan filter blok:', filterBlock.value);
            q = query(q, where('block', '==', filterBlock.value));
        }
        if (filterDate.value) {
            console.log('Menerapkan filter tanggal:', filterDate.value);
            q = query(q, where('date', '==', filterDate.value));
        }

        console.log('Memulai listener untuk laporan meter');
        onSnapshot(q, (snapshot) => {
            console.log('Snapshot diterima, jumlah dokumen:', snapshot.docs.length);
            reportBody.innerHTML = '';
            const meters = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            if (meters.length === 0) {
                console.log('Tidak ada data meter ditemukan');
                reportBody.innerHTML = '<tr><td colspan="8">Tidak ada data meter.</td></tr>';
            } else {
                meters.forEach(m => {
                    console.log('Menampilkan data meter:', m);
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${m.date || '-'}</td>
                        <td>${m.time || '-'}</td>
                        <td>${m.block || '-'}</td>
                        <td>${m.location || '-'}</td>
                        <td>${m.meterReading || 0} m³</td>
                        <td>${m.actualUsage ? m.actualUsage.toFixed(2) : '-'} m³</td>
                        <td>${m.notes || '-'}</td>
                        <td><button class="whatsapp-btn" data-detail='${JSON.stringify(m).replace(/'/g, "&apos;")}'><i class="fab fa-whatsapp"></i> Share</button></td>
                    `;
                    reportBody.appendChild(row);
                });
            }
        }, (error) => {
            console.error('Error fetching meter reports:', error);
            showNotification('Gagal memuat laporan meter: ' + error.message);
        });
    }

    // Fungsi untuk mengisi filter tanggal meter
    async function populateMeterDateFilter() {
        const snapshot = await getDocs(query(collection(db, 'meters'), orderBy('date', 'desc')));
        const dates = [...new Set(snapshot.docs.map(doc => doc.data().date))].sort((a, b) => new Date(b) - new Date(a));
        document.getElementById('meterFilterDate').innerHTML = '<option value="">Semua Tanggal</option>' +
            dates.map(d => `<option value="${d}">${d}</option>`).join('');
    }

    // Fungsi untuk mengisi filter blok kerusakan
    function populateDamageBlockFilter() {
        const damageFilterBlock = document.getElementById('damageFilterBlock');
        damageFilterBlock.innerHTML = '<option value="">Semua Blok</option>' +
            Object.keys(blockLocations).map(block => `<option value="${block}">${block}</option>`).join('');
    }

    // Fungsi untuk mengisi lokasi kerusakan
    function populateDamageLocations() {
        const blockSelect = document.getElementById('damageBlock');
        const locationSelect = document.getElementById('damageLocation');
        const selectedBlock = blockSelect.value;
        locationSelect.innerHTML = '<option value="">Pilih Lokasi...</option>';
        if (selectedBlock && blockLocations[selectedBlock]) {
            locationSelect.innerHTML += blockLocations[selectedBlock].map(loc => `<option value="${loc}">${loc}</option>`).join('');
        }
    }

    // Fungsi untuk menyimpan laporan kerusakan
    async function saveDamage(event) {
        event.preventDefault();
        const saveButton = document.getElementById('saveDamageButton');
        saveButton.disabled = true;
        saveButton.textContent = 'Menyimpan...';

        const now = new Date();
        const data = {
            nik: currentNIK,
            name: currentUserName,
            date: now.toLocaleDateString('id-ID'),
            time: now.toLocaleTimeString('id-ID'),
            damageType: document.getElementById('damageType').value,
            block: document.getElementById('damageBlock').value,
            location: document.getElementById('damageLocation').value,
            specific: document.getElementById('damageSpecific').value,
            notes: document.getElementById('damageNotes').value || '',
            createdAt: serverTimestamp()
        };

        const required = ['damageType', 'block', 'location', 'specific'];
        const missing = required.filter(field => !data[field]);
        if (missing.length > 0) {
            showNotification('Mohon lengkapi semua field yang wajib diisi!');
            saveButton.disabled = false;
            saveButton.textContent = 'Simpan Laporan';
            return;
        }

        try {
            console.log('Menyimpan laporan kerusakan:', data);
            await addDoc(collection(db, 'damages'), data);
            showNotification('Laporan kerusakan berhasil disimpan!', true);
            document.getElementById('damageForm').reset();
            document.getElementById('damageLocation').innerHTML = '<option value="">Pilih Lokasi...</option>';
        } catch (error) {
            console.error('Gagal menyimpan laporan kerusakan:', error);
            showNotification('Gagal menyimpan laporan: ' + error.message);
        } finally {
            saveButton.disabled = false;
            saveButton.textContent = 'Simpan Laporan';
        }
    }

    // Fungsi untuk memuat laporan kerusakan
    function listenDamageReports() {
        const filterBlock = document.getElementById('damageFilterBlock');
        const filterDate = document.getElementById('damageFilterDate');
        const reportBody = document.getElementById('damageReportBody');
        
        let q = query(collection(db, 'damages'), orderBy('createdAt', 'desc'));

        if (filterBlock.value) q = query(q, where('block', '==', filterBlock.value));
        if (filterDate.value) q = query(q, where('date', '==', filterDate.value));

        onSnapshot(q, (snapshot) => {
            reportBody.innerHTML = '';
            const damages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            if (damages.length === 0) {
                reportBody.innerHTML = '<tr><td colspan="7">Tidak ada laporan kerusakan.</td></tr>';
            } else {
                damages.forEach(d => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${d.date || '-'}</td>
                        <td>${d.damageType || '-'}</td>
                        <td>${d.block || '-'}</td>
                        <td>${d.location || '-'}</td>
                        <td>${d.specific || '-'}</td>
                        <td>${d.notes || '-'}</td>
                        <td><button class="whatsapp-btn" data-detail='${JSON.stringify(d).replace(/'/g, "&apos;")}'><i class="fab fa-whatsapp"></i> Share</button></td>
                    `;
                    reportBody.appendChild(row);
                });
            }
        }, (error) => {
            console.error('Error fetching damage reports:', error);
            showNotification('Gagal memuat laporan kerusakan.');
        });
    }

    // Fungsi untuk mengisi filter tanggal kerusakan
    async function populateDamageDateFilter() {
        const snapshot = await getDocs(query(collection(db, 'damages'), orderBy('date', 'desc')));
        const dates = [...new Set(snapshot.docs.map(doc => doc.data().date))].sort((a, b) => new Date(b) - new Date(a));
        document.getElementById('damageFilterDate').innerHTML = '<option value="">Semua Tanggal</option>' +
            dates.map(d => `<option value="${d}">${d}</option>`).join('');
    }

    // Fungsi untuk share laporan meter ke WhatsApp
    function shareMeter(data) {
        const message = encodeURIComponent(`
Laporan Meter Air
• Tanggal: ${data.date}
• Waktu: ${data.time}
• Blok: ${data.block}
• Lokasi: ${data.location}
• Angka Meter: ${data.meterReading} m³
• Penggunaan Aktual: ${data.actualUsage ? data.actualUsage.toFixed(2) : '-'} m³
• Catatan: ${data.notes || '-'}`);
        window.open(`https://wa.me/?text=${message}`, '_blank');
    }

    // Fungsi untuk share laporan kerusakan ke WhatsApp
    function shareDamage(data) {
        const message = encodeURIComponent(`
Laporan Kerusakan
• Tanggal: ${data.date}
• Jenis Kerusakan: ${data.damageType}
• Blok: ${data.block}
• Lokasi: ${data.location}
• Spesifik Lokasi: ${data.specific}
• Catatan: ${data.notes || '-'}`);
        window.open(`https://wa.me/?text=${message}`, '_blank');
    }

    // Inisialisasi aplikasi
    document.addEventListener('DOMContentLoaded', () => {
        const savedTheme = localStorage.getItem('theme') || 'dark';
        document.body.classList.add(`${savedTheme}-theme`);
        document.getElementById('themeIcon').classList.add(savedTheme === 'dark' ? 'fa-sun' : 'fa-moon');

        document.getElementById('loginButton').addEventListener('click', login);
        document.getElementById('themeToggle').addEventListener('click', toggleTheme);
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => switchPage(item.dataset.page));
        });

        document.getElementById('switchMasuk').addEventListener('click', () => switchType('masuk'));
        document.getElementById('switchPulang').addEventListener('click', () => switchType('pulang'));
        document.getElementById('switchCustom').addEventListener('click', () => switchType('custom'));
        document.getElementById('checklistForm').addEventListener('submit', saveChecklist);

        document.getElementById('reportTable').addEventListener('click', (e) => {
            const detailBtn = e.target.closest('.detail-btn');
            const whatsappBtn = e.target.closest('.whatsapp-btn');
            const editBtn = e.target.closest('.edit-btn');
            if (detailBtn) {
                const data = JSON.parse(detailBtn.getAttribute('data-detail'));
                showDetail(data);
            }
            if (whatsappBtn) {
                const data = JSON.parse(whatsappBtn.getAttribute('data-detail'));
                shareChecklist(data);
            }
            if (editBtn && !editBtn.disabled) {
                const data = JSON.parse(editBtn.getAttribute('data-detail'));
                showEditForm(data);
            }
        });

        document.getElementById('modalClose').addEventListener('click', closeModal);
        document.getElementById('modalOverlay').addEventListener('click', closeModal);

        document.getElementById('meterBlock').addEventListener('change', () => {
            populateMeterLocations();
            updateActualUsage();
        });
        document.getElementById('meterLocation').addEventListener('change', updateActualUsage);
        document.getElementById('meterReading').addEventListener('input', updateActualUsage);
        document.getElementById('meterForm').addEventListener('submit', saveMeter);

        document.getElementById('meterTable').addEventListener('click', (e) => {
            const whatsappBtn = e.target.closest('.whatsapp-btn');
            if (whatsappBtn) {
                const data = JSON.parse(whatsappBtn.getAttribute('data-detail'));
                shareMeter(data);
            }
        });

        document.getElementById('meterFilterBlock').addEventListener('change', listenMeterReports);
        document.getElementById('meterFilterDate').addEventListener('change', listenMeterReports);

        document.getElementById('damageBlock').addEventListener('change', populateDamageLocations);
        document.getElementById('damageForm').addEventListener('submit', saveDamage);

        document.getElementById('damageTable').addEventListener('click', (e) => {
            const whatsappBtn = e.target.closest('.whatsapp-btn');
            if (whatsappBtn) {
                const data = JSON.parse(whatsappBtn.getAttribute('data-detail'));
                shareDamage(data);
            }
        });

        document.getElementById('filterDate').addEventListener('change', listenReports);
        document.getElementById('filterShift').addEventListener('change', listenReports);
        document.getElementById('filterNIK').addEventListener('change', listenReports);

        populateFilters();
        listenReports();
        populateMeterBlockFilter();
        populateMeterDateFilter();
        listenMeterReports();
        populateDamageBlockFilter();
        populateDamageDateFilter();
        listenDamageReports();

        setInterval(updateTime, 1000);
    });
</script>
</body>
</html>
